<template>
  <PageContainer>
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="action-bar">
      <div class="action-bar-left">
        <el-button @click="$router.back()">
          <el-icon><ArrowLeft /></el-icon>
          è¿”å›
        </el-button>
        <span class="page-title">PI Planning - å›¢é˜Ÿè§†è§’: æ¨¡å—éœ€æ±‚æ’å¸ƒ</span>
        <el-tag v-if="currentPI" :type="getPIStatusType(currentPI.status)" size="large" style="margin-left: 12px;">
          {{ currentPI.name }}
        </el-tag>
      </div>
      <div class="action-bar-right">
        <el-button @click="handleSaveDraft">ä¿å­˜è‰ç¨¿</el-button>
      </div>
    </div>

    <!-- PIä¿¡æ¯å¡ç‰‡ -->
    <el-card style="margin-bottom: 16px;" v-if="currentPI">
      <el-descriptions :column="4" border>
        <el-descriptions-item label="PIåç§°">
          <el-text tag="b">{{ currentPI.name }}</el-text>
        </el-descriptions-item>
        <el-descriptions-item label="å›¢é˜Ÿè§„åˆ’è¿›åº¦" :span="2">
          <el-text>{{ completedTeamsCount }}/{{ teams.length }} å›¢é˜Ÿå·²è§„åˆ’</el-text>
        </el-descriptions-item>
        <el-descriptions-item label="æ•´ä½“è¿›åº¦" :span="2">
          <el-progress :percentage="stage2Progress" />
        </el-descriptions-item>
      </el-descriptions>
    </el-card>

    <!-- å›¢é˜Ÿé€‰æ‹© -->
    <el-card style="margin-bottom: 16px;">
      <template #header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <el-text tag="b" size="large">é€‰æ‹©å›¢é˜Ÿ</el-text>
            <el-text size="small" type="info" style="margin-left: 12px;">
              å•å›¢é˜Ÿè§†è§’ï¼šé€‰æ‹©ä¸€ä¸ªå›¢é˜Ÿï¼Œè§„åˆ’è¯¥å›¢é˜Ÿçš„æ¨¡å—éœ€æ±‚åˆ°ä¸åŒè¿­ä»£
            </el-text>
          </div>
          <el-button type="primary" plain @click="$router.push(`/function/c3/planning/pi/${piId}/stage1`)">
            <el-icon><ArrowLeft /></el-icon>
            åˆ‡æ¢åˆ°å…¨å±€è§†è§’
          </el-button>
        </div>
      </template>
      <el-radio-group v-model="selectedTeamId" size="large">
        <el-radio-button 
          v-for="team in teams" 
          :key="team.id"
          :label="team.id"
        >
          {{ team.name }}
          <el-tag 
            v-if="getTeamStage2Status(team.id) === 'completed'" 
            type="success" 
            size="small" 
            style="margin-left: 8px;"
          >
            å·²å®Œæˆ
          </el-tag>
        </el-radio-button>
      </el-radio-group>
    </el-card>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <el-row :gutter="16" v-if="selectedTeamId">
      <!-- å·¦ä¾§ï¼šç‰¹æ€§æ ‘ï¼ˆFeature â†’ SSTS â†’ MRï¼‰ -->
      <el-col :span="12">
        <el-card shadow="hover" style="height: calc(100vh - 400px); overflow-y: auto;">
          <template #header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>{{ getTeamName(selectedTeamId) }} - ç‰¹æ€§éœ€æ±‚æ ‘</span>
              <el-button size="small" @click="expandAll = !expandAll">
                {{ expandAll ? 'å…¨éƒ¨æ”¶èµ·' : 'å…¨éƒ¨å±•å¼€' }}
              </el-button>
            </div>
          </template>

          <div 
            v-for="sprint in teamSprints" 
            :key="sprint.id"
            class="sprint-card"
            :class="{ 'drop-target': dragTargetSprintId === sprint.id }"
            @dragover.prevent="handleDragOver($event, sprint.id)"
            @drop="handleDrop($event, sprint.id)"
            @dragleave="handleDragLeave"
          >
            <div class="sprint-header">
              <div>
                <el-text tag="b">{{ sprint.name }}</el-text>
                <el-text size="small" type="info" style="margin-left: 8px;">
                  {{ formatSprintDates(sprint) }}
                </el-text>
              </div>
              <el-tag size="small" :type="getLoadRateType(sprint)">
                {{ getSprintLoadRate(sprint) }}%
              </el-tag>
            </div>

            <div class="sprint-capacity">
              <el-text size="small" type="info">
                å®¹é‡: {{ sprint.capacity }} SP | 
                Feature/SSTSè´Ÿè½½: {{ getFeatureSSTSLoad(sprint) }} SP | 
                MRè´Ÿè½½: {{ getMRLoad(sprint) }} SP | 
                å¯ç”¨: {{ getAvailableCapacity(sprint) }} SP
              </el-text>
              <el-progress 
                :percentage="getSprintLoadRate(sprint)" 
                :status="getSprintLoadRate(sprint) > 100 ? 'exception' : undefined"
                :stroke-width="8"
                style="margin-top: 8px;"
              >
                <template #default>
                  <span style="font-size: 12px;">
                    {{ getFeatureSSTSLoad(sprint) + getMRLoad(sprint) }}/{{ sprint.capacity }} SP
                  </span>
                </template>
              </el-progress>
            </div>

            <!-- Feature/SSTSåˆ†é…ï¼ˆåªè¯»ï¼Œæ¥è‡ªå…¨å±€è§†è§’ï¼‰ -->
            <div class="stage1-items" v-if="getStage1Items(sprint.id).length > 0">
              <el-text size="small" type="info" style="margin-bottom: 8px; display: block;">
                å…¨å±€è§†è§’åˆ†é…ï¼ˆåªè¯»ï¼‰:
              </el-text>
              <div 
                v-for="item in getStage1Items(sprint.id)"
                :key="`stage1-${item.type}-${item.id}`"
                class="stage1-item"
              >
                <el-icon><Lock /></el-icon>
                <el-text size="small">{{ item.code }}</el-text>
                <el-text size="small" type="info">{{ item.storyPoints || getSSTSStoryPoints(item) }} SP</el-text>
              </div>
            </div>

            <!-- MRåˆ†é…ï¼ˆå›¢é˜Ÿè§†è§’ï¼‰ -->
            <div class="mr-items">
              <el-text size="small" type="success" style="margin-bottom: 8px; display: block;">
                MRåˆ†é…:
              </el-text>
              <div 
                v-for="mr in getMRsInSprint(sprint.id)"
                :key="mr.id"
                class="mr-item"
                draggable="true"
                @dragstart="handleDragStart($event, mr)"
              >
                <div class="mr-header">
                  <el-text tag="b" size="small">{{ mr.code }}</el-text>
                  <el-button 
                    size="small" 
                    text 
                    type="danger"
                    @click.stop="handleRemoveMR(mr.id, sprint.id)"
                  >
                    <el-icon><Close /></el-icon>
                  </el-button>
                </div>
                <el-text size="small" class="mr-title">{{ mr.title || mr.name }}</el-text>
                <div class="mr-meta">
                  <el-tag size="small">{{ mr.storyPoints }} SP</el-tag>
                  <el-text size="small" type="info">SSTS: {{ getSSTSCode(mr.sstsId) }}</el-text>
                </div>
              </div>
            </div>

            <!-- æ”¾ç½®æç¤º -->
            <div v-if="getMRsInSprint(sprint.id).length === 0" class="drop-hint">
              [+ æ”¾ç½®MRåˆ°æ­¤å¤„]
            </div>
          </div>
        </el-card>
      </el-col>

      <!-- å³ä¾§ï¼šMRåˆ—è¡¨ï¼ˆæŒ‰è¿­ä»£åˆ†ç»„ï¼‰ -->
      <el-col :span="12">
        <el-card shadow="hover" style="height: calc(100vh - 400px); overflow-y: auto;">
          <template #header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>MRåˆ—è¡¨ï¼ˆæŒ‰è¿­ä»£åˆ†ç»„ï¼‰</span>
              <el-select v-model="mrFilter" size="small" style="width: 150px;">
                <el-option label="å…¨éƒ¨" value="all" />
                <el-option label="æœªåˆ†é…" value="unallocated" />
                <el-option label="å·²åˆ†é…" value="allocated" />
              </el-select>
            </div>
          </template>

          <!-- æœç´¢ -->
          <el-input 
            v-model="mrSearchKeyword" 
            placeholder="æœç´¢MR..." 
            clearable 
            style="margin-bottom: 12px;"
          >
            <template #prefix>
              <el-icon><Search /></el-icon>
            </template>
          </el-input>

          <!-- æŒ‰Sprintåˆ†ç»„çš„MR -->
          <div 
            v-for="sprint in teamSprints" 
            :key="sprint.id"
            class="mr-group"
          >
            <div class="mr-group-header">
              <el-text tag="b">{{ sprint.name }}</el-text>
              <el-text size="small" type="info">
                {{ formatSprintDates(sprint) }} | 
                å®¹é‡: {{ sprint.capacity }} SP | 
                å·²ç”¨: {{ getFeatureSSTSLoad(sprint) + getMRLoad(sprint) }} SP
              </el-text>
            </div>

            <!-- è¯¥Sprintçš„SSTS -->
            <div class="ssts-info" v-if="getSprintSSTS(sprint.id).length > 0">
              <el-text size="small" type="info">æ‰€å±SSTS: </el-text>
              <el-tag 
                v-for="ssts in getSprintSSTS(sprint.id)"
                :key="ssts.id"
                size="small"
                style="margin-right: 4px;"
              >
                {{ ssts.code }}
              </el-tag>
            </div>

            <!-- è¯¥Sprintçš„MRï¼ˆé»˜è®¤åŸºäºSSTSåˆ†é…ï¼‰ -->
            <div class="mr-list">
              <div 
                v-for="mr in getMRsForSprint(sprint.id)"
                :key="mr.id"
                class="mr-card"
                :class="{ 'allocated': isMRAllocated(mr.id) }"
                draggable="true"
                @dragstart="handleDragStart($event, mr)"
                @click="handleViewMR(mr.id)"
              >
                <div class="mr-card-header">
                  <el-text tag="b">{{ mr.code }}</el-text>
                  <el-tag v-if="isMRAllocated(mr.id)" type="success" size="small">å·²åˆ†é…</el-tag>
                </div>
                <el-text class="mr-card-title">{{ mr.title || mr.name }}</el-text>
                <div class="mr-card-meta">
                  <el-tag size="small">{{ mr.storyPoints }} SP</el-tag>
                  <el-tag size="small" :type="getPriorityType(mr.priority)">{{ mr.priority }}</el-tag>
                  <el-text size="small" type="info">SSTS: {{ getSSTSCode(mr.sstsId) }}</el-text>
                </div>
                <div class="mr-card-meta" v-if="mr.dependencies?.length">
                  <el-text size="small" type="warning">ä¾èµ–: {{ mr.dependencies.length }}ä¸ª</el-text>
                </div>
                <div class="mr-card-hint" v-if="!isMRAllocated(mr.id)">
                  <el-text size="small" type="info">ğŸ’¡ é»˜è®¤ä½ç½®ï¼ˆæ‰€å±SSTSåœ¨æ­¤Sprintï¼‰</el-text>
                </div>
              </div>
            </div>
          </div>

          <!-- æœªåˆ†é…MRï¼ˆæ‰€å±SSTSæœªåˆ†é…ï¼‰ -->
          <div class="mr-group" v-if="unallocatedMRs.length > 0">
            <div class="mr-group-header">
              <el-text tag="b" type="warning">æœªåˆ†é…MR</el-text>
              <el-text size="small" type="info">æ‰€å±SSTSæœªåˆ†é…åˆ°Sprint</el-text>
            </div>
            <div class="mr-list">
              <div 
                v-for="mr in unallocatedMRs"
                :key="mr.id"
                class="mr-card"
                draggable="true"
                @dragstart="handleDragStart($event, mr)"
              >
                <div class="mr-card-header">
                  <el-text tag="b">{{ mr.code }}</el-text>
                </div>
                <el-text class="mr-card-title">{{ mr.title || mr.name }}</el-text>
                <div class="mr-card-meta">
                  <el-tag size="small">{{ mr.storyPoints }} SP</el-tag>
                  <el-text size="small" type="warning">âš ï¸ æ‰€å±SSTSæœªåˆ†é…</el-text>
                </div>
              </div>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
  </PageContainer>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  ArrowLeft, Search, Lock, Close
} from '@element-plus/icons-vue'
import PageContainer from '@/components/Common/PageContainer.vue'
import { usePIStore } from '@/stores/modules/pi'
import { useSprintStore } from '@/stores/modules/sprint'
import { useFeatureStore } from '@/stores/modules/feature'
import { useSSTSStore } from '@/stores/modules/ssts'
import { useTeamStore } from '@/stores/modules/team'
import { useMRStore } from '@/stores/modules/mr'
import dayjs from 'dayjs'

// ============================================================================
// Setup
// ============================================================================

const route = useRoute()
const router = useRouter()
const piStore = usePIStore()
const sprintStore = useSprintStore()
const featureStore = useFeatureStore()
const sstsStore = useSSTSStore()
const teamStore = useTeamStore()
const mrStore = useMRStore()

const piId = route.params.piId as string

// ============================================================================
// State
// ============================================================================

const loading = ref(false)
const selectedTeamId = ref('')
const mrSearchKeyword = ref('')
const mrFilter = ref<'all' | 'unallocated' | 'allocated'>('all')
const dragTargetSprintId = ref<string | null>(null)
const draggedMR = ref<any>(null)

// å…¨å±€è§†è§’çš„åˆ†é…ç»“æœï¼ˆåªè¯»ï¼‰
const stage1Allocations = ref<{
  features: Array<{ featureId: string; teamId: string; sprintId: string }>
  sstss: Array<{ sstsId: string; teamId: string; sprintId: string }>
}>({
  features: [],
  sstss: []
})

// å›¢é˜Ÿè§†è§’çš„MRåˆ†é…
const stage2MRAllocations = ref<Array<{
  mrId: string
  sprintId: string
}>>([])

// å›¢é˜Ÿå®ŒæˆçŠ¶æ€
const teamCompletionStatus = ref<Record<string, boolean>>({})

// ============================================================================
// Computed
// ============================================================================

const currentPI = computed(() => {
  return piStore.piVersions.find(p => p.id === piId)
})

const teams = computed(() => teamStore.teams)

const selectedTeam = computed(() => {
  return teams.value.find(t => t.id === selectedTeamId.value)
})

// è¯¥å›¢é˜Ÿåœ¨å…¨å±€è§†è§’ä¸­åˆ†é…çš„Sprint
const teamSprints = computed(() => {
  if (!selectedTeamId.value) return []
  
  const sprintIds = new Set<string>()
  
  // ä»å…¨å±€è§†è§’åˆ†é…ä¸­æ‰¾å‡ºè¯¥å›¢é˜Ÿçš„Sprint
  stage1Allocations.value.features.forEach(alloc => {
    if (alloc.teamId === selectedTeamId.value) {
      sprintIds.add(alloc.sprintId)
    }
  })
  stage1Allocations.value.sstss.forEach(alloc => {
    if (alloc.teamId === selectedTeamId.value) {
      sprintIds.add(alloc.sprintId)
    }
  })

  return sprintStore.sprints
    .filter(s => s.piId === piId && sprintIds.has(s.id))
    .sort((a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime())
})

// è¯¥å›¢é˜Ÿçš„æ‰€æœ‰MRï¼ˆä»SSTSæ‹†è§£å‡ºçš„ï¼‰
const teamMRs = computed(() => {
  if (!selectedTeamId.value) return []
  
  // æ‰¾å‡ºè¯¥å›¢é˜Ÿåœ¨å…¨å±€è§†è§’ä¸­åˆ†é…çš„SSTS
  const teamSSTSIds = stage1Allocations.value.sstss
    .filter(alloc => alloc.teamId === selectedTeamId.value)
    .map(alloc => alloc.sstsId)
  
  // æ‰¾å‡ºè¿™äº›SSTSä¸‹çš„MR
  return mrStore.mrList.filter(mr => teamSSTSIds.includes(mr.sstsId))
})

// æœªåˆ†é…çš„MRï¼ˆæ‰€å±SSTSæœªåˆ†é…ï¼‰
const unallocatedMRs = computed(() => {
  return teamMRs.value.filter(mr => {
    const sstsAlloc = stage1Allocations.value.sstss.find(a => a.sstsId === mr.sstsId)
    return !sstsAlloc
  })
})

const completedTeamsCount = computed(() => {
  return Object.values(teamCompletionStatus.value).filter(Boolean).length
})

const stage2Progress = computed(() => {
  return teams.value.length > 0 
    ? Math.round((completedTeamsCount.value / teams.value.length) * 100)
    : 0
})

// ç§»é™¤canCompleteStage2ï¼Œä¸å†æœ‰å®Œæˆçš„æ¦‚å¿µ

// ============================================================================
// Methods
// ============================================================================

function formatSprintDates(sprint: any) {
  return `${dayjs(sprint.startDate).format('MM/DD')} ~ ${dayjs(sprint.endDate).format('MM/DD')}`
}

function getTeamName(teamId: string) {
  const team = teams.value.find(t => t.id === teamId)
  return team?.name || teamId
}

function getPIStatusType(status: string) {
  const map: Record<string, 'success' | 'warning' | 'info' | ''> = {
    'planning': 'info',
    'committed': 'warning',
    'in-progress': 'warning',
    'completed': 'success'
  }
  return map[status] || 'info'
}

function getPriorityType(priority: string) {
  const map: Record<string, 'danger' | 'warning' | 'info' | ''> = {
    'P0': 'danger',
    'P1': 'warning',
    'P2': 'info',
    'P3': ''
  }
  return map[priority] || 'info'
}

function getSSTSStoryPoints(ssts: any) {
  return ssts.storyPoints || ssts.estimate || 0
}

function getSSTSCode(sstsId: string) {
  const ssts = sstsStore.sstsList.find(s => s.id === sstsId)
  return ssts?.code || sstsId
}

// è·å–å…¨å±€è§†è§’åˆ†é…çš„Feature/SSTSï¼ˆåªè¯»ï¼‰
function getStage1Items(sprintId: string) {
  const items: any[] = []
  
  // Feature
  stage1Allocations.value.features.forEach(alloc => {
    if (alloc.teamId === selectedTeamId.value && alloc.sprintId === sprintId) {
      const feature = featureStore.features.find(f => f.id === alloc.featureId)
      if (feature) {
        items.push({ ...feature, type: 'feature' })
      }
    }
  })

  // SSTS
  stage1Allocations.value.sstss.forEach(alloc => {
    if (alloc.teamId === selectedTeamId.value && alloc.sprintId === sprintId) {
      const ssts = sstsStore.sstsList.find(s => s.id === alloc.sstsId)
      if (ssts) {
        items.push({ ...ssts, type: 'ssts' })
      }
    }
  })

  return items
}

// è·å–Sprintçš„Feature/SSTSè´Ÿè½½ï¼ˆæ¥è‡ªå…¨å±€è§†è§’ï¼‰
function getFeatureSSTSLoad(sprint: any) {
  const items = getStage1Items(sprint.id)
  return items.reduce((sum, item) => {
    if (item.type === 'feature') {
      return sum + (item.storyPoints || 0)
    } else {
      return sum + getSSTSStoryPoints(item)
    }
  }, 0)
}

// è·å–Sprintçš„MRè´Ÿè½½ï¼ˆå›¢é˜Ÿè§†è§’ï¼‰
function getMRLoad(sprint: any) {
  const mrs = getMRsInSprint(sprint.id)
  return mrs.reduce((sum, mr) => sum + (mr.storyPoints || 0), 0)
}

// è·å–å¯ç”¨å®¹é‡
function getAvailableCapacity(sprint: any) {
  const used = getFeatureSSTSLoad(sprint) + getMRLoad(sprint)
  return Math.max(0, sprint.capacity - used)
}

// è·å–è´Ÿè½½ç‡
function getSprintLoadRate(sprint: any) {
  const used = getFeatureSSTSLoad(sprint) + getMRLoad(sprint)
  return sprint.capacity > 0 ? Math.round((used / sprint.capacity) * 100) : 0
}

function getLoadRateType(sprint: any) {
  const rate = getSprintLoadRate(sprint)
  if (rate > 100) return 'danger'
  if (rate > 90) return 'warning'
  return 'success'
}

// è·å–Sprintä¸­çš„SSTSï¼ˆç”¨äºæ˜¾ç¤ºMRçš„æ‰€å±SSTSï¼‰
function getSprintSSTS(sprintId: string) {
  return stage1Allocations.value.sstss
    .filter(alloc => alloc.teamId === selectedTeamId.value && alloc.sprintId === sprintId)
    .map(alloc => sstsStore.sstsList.find(s => s.id === alloc.sstsId))
    .filter(Boolean)
}

// è·å–è¯¥Sprintçš„MRï¼ˆé»˜è®¤åŸºäºSSTSåˆ†é…ï¼‰
function getMRsForSprint(sprintId: string) {
  // æ‰¾å‡ºè¯¥Sprintä¸­çš„SSTS
  const sprintSSTSIds = stage1Allocations.value.sstss
    .filter(alloc => alloc.teamId === selectedTeamId.value && alloc.sprintId === sprintId)
    .map(alloc => alloc.sstsId)
  
  // æ‰¾å‡ºè¿™äº›SSTSä¸‹çš„MR
  let mrs = teamMRs.value.filter(mr => sprintSSTSIds.includes(mr.sstsId))
  
  // æœç´¢è¿‡æ»¤
  if (mrSearchKeyword.value) {
    const keyword = mrSearchKeyword.value.toLowerCase()
    mrs = mrs.filter(mr => 
      mr.code.toLowerCase().includes(keyword) || 
      (mr.title || mr.name || '').toLowerCase().includes(keyword)
    )
  }
  
  // çŠ¶æ€è¿‡æ»¤
  if (mrFilter.value === 'allocated') {
    mrs = mrs.filter(mr => isMRAllocated(mr.id))
  } else if (mrFilter.value === 'unallocated') {
    mrs = mrs.filter(mr => !isMRAllocated(mr.id))
  }
  
  return mrs
}

// è·å–Sprintä¸­å·²åˆ†é…çš„MR
function getMRsInSprint(sprintId: string) {
  return stage2MRAllocations.value
    .filter(alloc => alloc.sprintId === sprintId)
    .map(alloc => teamMRs.value.find(mr => mr.id === alloc.mrId))
    .filter(Boolean)
}

// æ£€æŸ¥MRæ˜¯å¦å·²åˆ†é…
function isMRAllocated(mrId: string) {
  return stage2MRAllocations.value.some(alloc => alloc.mrId === mrId)
}

function handleDragStart(event: DragEvent, mr: any) {
  draggedMR.value = mr
  if (event.dataTransfer) {
    event.dataTransfer.effectAllowed = 'move'
  }
}

function handleDragOver(event: DragEvent, sprintId: string) {
  event.preventDefault()
  dragTargetSprintId.value = sprintId
  if (event.dataTransfer) {
    event.dataTransfer.dropEffect = 'move'
  }
}

function handleDragLeave() {
  dragTargetSprintId.value = null
}

function handleDrop(event: DragEvent, sprintId: string) {
  event.preventDefault()
  dragTargetSprintId.value = null

  if (!draggedMR.value) return

  const mr = draggedMR.value
  const sprint = teamSprints.value.find(s => s.id === sprintId)

  if (!sprint) return

  // å®¹é‡æ£€æŸ¥
  const currentLoad = getFeatureSSTSLoad(sprint) + getMRLoad(sprint)
  const mrSP = mr.storyPoints || 0
  
  if (currentLoad + mrSP > sprint.capacity) {
    ElMessage.warning(`å®¹é‡ä¸è¶³ï¼å½“å‰è´Ÿè½½: ${currentLoad} SPï¼Œæ·»åŠ å: ${currentLoad + mrSP} SPï¼Œå®¹é‡: ${sprint.capacity} SP`)
    draggedMR.value = null
    return
  }

  // ä¾èµ–æ£€æŸ¥
  if (mr.dependencies && Array.isArray(mr.dependencies) && mr.dependencies.length > 0) {
    // å¤„ç†ä¾èµ–ï¼šå¯èƒ½æ˜¯å­—ç¬¦ä¸²æ•°ç»„æˆ–Dependencyå¯¹è±¡æ•°ç»„
    const depIds = mr.dependencies.map((dep: any) => {
      return typeof dep === 'string' ? dep : dep.targetId || dep.id
    })
    
    const unmetDeps = depIds.filter((depId: string) => {
      const depAlloc = stage2MRAllocations.value.find(a => a.mrId === depId)
      if (!depAlloc) return true // ä¾èµ–æœªåˆ†é…
      // æ£€æŸ¥ä¾èµ–æ˜¯å¦åœ¨æ›´æ—©çš„Sprint
      const depSprint = teamSprints.value.find(s => s.id === depAlloc.sprintId)
      const currentSprint = teamSprints.value.find(s => s.id === sprintId)
      if (depSprint && currentSprint) {
        return new Date(depSprint.endDate) > new Date(currentSprint.startDate)
      }
      return false
    })

    if (unmetDeps.length > 0) {
      ElMessage.warning(`ä¾èµ–æœªæ»¡è¶³ï¼è¯·å…ˆåˆ†é…ä¾èµ–çš„MR`)
      draggedMR.value = null
      return
    }
  }

  // ç§»é™¤æ—§åˆ†é…
  const index = stage2MRAllocations.value.findIndex(a => a.mrId === mr.id)
  if (index !== -1) {
    stage2MRAllocations.value.splice(index, 1)
  }

  // æ·»åŠ æ–°åˆ†é…
  stage2MRAllocations.value.push({
    mrId: mr.id,
    sprintId
  })

  ElMessage.success('MRå·²åˆ†é…')
  draggedMR.value = null
}

function handleRemoveMR(mrId: string, sprintId: string) {
  const index = stage2MRAllocations.value.findIndex(
    a => a.mrId === mrId && a.sprintId === sprintId
  )
  if (index !== -1) {
    stage2MRAllocations.value.splice(index, 1)
    ElMessage.success('MRå·²ç§»é™¤')
  }
}

function handleViewMR(mrId: string) {
  router.push(`/function/c1-requirement/mr/${mrId}`)
}

function handleSaveDraft() {
  const draft = {
    piId,
    teamId: selectedTeamId.value,
    mrAllocations: stage2MRAllocations.value,
    updatedAt: new Date().toISOString()
  }
  localStorage.setItem(`pi-planning-stage2-draft-${piId}-${selectedTeamId.value}`, JSON.stringify(draft))
  ElMessage.success('è‰ç¨¿å·²ä¿å­˜')
}

function handleCompleteStage2() {
  if (!selectedTeamId.value) return

  ElMessageBox.confirm('ç¡®å®šè¦å®Œæˆè¯¥å›¢é˜Ÿçš„é˜¶æ®µ2è§„åˆ’å—ï¼Ÿ', 'ç¡®è®¤å®Œæˆ', {
    confirmButtonText: 'å®Œæˆ',
    cancelButtonText: 'å–æ¶ˆ',
    type: 'warning'
  }).then(() => {
    teamCompletionStatus.value[selectedTeamId.value] = true
    handleSaveDraft()
    ElMessage.success('é˜¶æ®µ2å·²å®Œæˆ')
    
    // å¦‚æœæ‰€æœ‰å›¢é˜Ÿéƒ½å®Œæˆï¼Œæç¤ºå®ŒæˆPI Planning
    if (canCompleteStage2.value) {
      ElMessageBox.confirm('æ‰€æœ‰å›¢é˜Ÿå·²å®Œæˆé˜¶æ®µ2ï¼Œæ˜¯å¦å®ŒæˆPI Planningï¼Ÿ', 'å®ŒæˆPI Planning', {
        confirmButtonText: 'å®Œæˆ',
        cancelButtonText: 'ç¨å',
        type: 'success'
      }).then(() => {
        ElMessage.success('PI Planningå·²å®Œæˆï¼')
      }).catch(() => {})
    }
  }).catch(() => {})
}

function getTeamStage2Status(teamId: string) {
  return teamCompletionStatus.value[teamId] ? 'completed' : 'in-progress'
}

// æ³¨ï¼šè™½ç„¶ä¿ç•™teamCompletionStatusè·Ÿè¸ªçŠ¶æ€ï¼Œä½†ä¸å†å¼ºåˆ¶"å®Œæˆ"æµç¨‹

// ============================================================================
// Lifecycle
// ============================================================================

onMounted(async () => {
  loading.value = true
  try {
    await piStore.fetchPIById(piId)
    
    // åŠ è½½å…¨å±€è§†è§’çš„åˆ†é…ç»“æœï¼ˆä¸æ£€æŸ¥æ˜¯å¦å®Œæˆï¼Œå…è®¸éšæ—¶åˆ‡æ¢ï¼‰
    const stage1Draft = localStorage.getItem(`pi-planning-stage1-draft-${piId}`)
    if (stage1Draft) {
      const stage1Data = JSON.parse(stage1Draft)
    stage1Allocations.value = stage1Data.allocations || { features: [], sstss: [] }

      stage1Allocations.value = stage1Data.allocations || { features: [], sstss: [] }
    }

    // åŠ è½½å›¢é˜Ÿè§†è§’è‰ç¨¿
    if (teams.value.length > 0) {
      selectedTeamId.value = teams.value[0].id
      const draft = localStorage.getItem(`pi-planning-stage2-draft-${piId}-${selectedTeamId.value}`)
      if (draft) {
        const draftData = JSON.parse(draft)
        stage2MRAllocations.value = draftData.mrAllocations || []
        teamCompletionStatus.value[selectedTeamId.value] = draftData.completed || false
      }
    }
  } catch (error) {
    ElMessage.error('åŠ è½½å¤±è´¥')
  } finally {
    loading.value = false
  }
})

// åˆ‡æ¢å›¢é˜Ÿæ—¶åŠ è½½è¯¥å›¢é˜Ÿçš„è‰ç¨¿
watch(selectedTeamId, (newTeamId) => {
  if (newTeamId) {
    const draft = localStorage.getItem(`pi-planning-stage2-draft-${piId}-${newTeamId}`)
    if (draft) {
      const draftData = JSON.parse(draft)
      stage2MRAllocations.value = draftData.mrAllocations || []
      teamCompletionStatus.value[newTeamId] = draftData.completed || false
    } else {
      stage2MRAllocations.value = []
      teamCompletionStatus.value[newTeamId] = false
    }
  }
})
</script>

<style scoped>
.action-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.action-bar-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-title {
  font-size: 20px;
  font-weight: 600;
  color: #303133;
}

.sprint-card {
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid #e4e7ed;
  border-radius: 4px;
  background: white;
  transition: all 0.3s;
}

.sprint-card.drop-target {
  border-color: #67c23a;
  background-color: #f0f9ff;
}

.sprint-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.sprint-capacity {
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid #e4e7ed;
}

.stage1-items {
  margin-bottom: 12px;
  padding: 8px;
  background: #f5f7fa;
  border-radius: 4px;
}

.stage1-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
  font-size: 12px;
  color: #909399;
}

.mr-items {
  min-height: 100px;
}

.mr-item {
  padding: 8px;
  margin-bottom: 8px;
  border: 1px solid #e4e7ed;
  border-radius: 4px;
  background: white;
  cursor: move;
  transition: all 0.3s;
}

.mr-item:hover {
  border-color: #409eff;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.mr-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.mr-title {
  display: block;
  margin-bottom: 4px;
  font-size: 12px;
  color: #606266;
}

.mr-meta {
  display: flex;
  gap: 8px;
  align-items: center;
  font-size: 12px;
}

.drop-hint {
  text-align: center;
  color: #c0c4cc;
  font-size: 12px;
  padding: 20px;
  border: 1px dashed #dcdfe6;
  border-radius: 4px;
}

.mr-group {
  margin-bottom: 24px;
}

.mr-group-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid #e4e7ed;
}

.ssts-info {
  margin-bottom: 8px;
  padding: 8px;
  background: #f5f7fa;
  border-radius: 4px;
  font-size: 12px;
}

.mr-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.mr-card {
  padding: 12px;
  border: 1px solid #e4e7ed;
  border-radius: 4px;
  background: white;
  cursor: move;
  transition: all 0.3s;
}

.mr-card:hover {
  border-color: #409eff;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.mr-card.allocated {
  border-left: 3px solid #67c23a;
  background: #f0f9ff;
}

.mr-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.mr-card-title {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  color: #606266;
}

.mr-card-meta {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-top: 8px;
  font-size: 12px;
}

.mr-card-hint {
  margin-top: 8px;
  font-size: 12px;
  color: #909399;
}
</style>
