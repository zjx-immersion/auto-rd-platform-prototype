# 端到端测试修复计划

> **计划日期**: 2026-01-17  
> **优先级**: 🔴 高  
> **预计修复时间**: 2-3小时

---

## 📋 修复任务清单

### 🔴 高优先级（必须修复）

#### 1. 修复Tab选择器问题 ✅ 已完成

**问题描述**:
- Tab选择器 `text=/Feature|特性/` 匹配到了菜单项而不是Tab元素
- 导致Tab点击失败，测试用例Phase 2.2和Phase 8.1失败

**修复方案**:
```typescript
// 修复前
const featureTab = page.locator('text=/Feature|特性/').first()

// 修复后
const featureTab = page.locator('div[role="tab"]:has-text("Features"), .el-tabs__item:has-text("Features")').first()
await featureTab.click({ force: true })
```

**修复文件**:
- `frontend/tests/e2e-domain-to-pi-planning.spec.ts`

**修复状态**: ✅ 已完成

**验证方法**: 重新执行测试用例Phase 2.2和Phase 8.1

---

#### 2. 修复SSTS Store方法缺失

**问题描述**:
```
sstsStore.getMRsBySSTS is not a function
```

**影响范围**:
- SSTS详情页面无法显示MR列表
- Phase 6.2测试用例可能受影响

**修复方案**:

**文件**: `frontend/src/stores/modules/ssts.ts`

**添加方法**:
```typescript
/**
 * 根据SSTS ID获取关联的MR列表
 */
function getMRsBySSTS(sstsId: string): MR[] {
  return mrList.value.filter(mr => mr.sstsId === sstsId)
}

// 在return中导出
return {
  // ... 其他方法
  getMRsBySSTS,
}
```

**修复状态**: ⏳ 待修复

**优先级**: 🔴 高

---

#### 3. 修复PI Store方法缺失

**问题描述**:
```
piStore.fetchPIs is not a function
```

**影响范围**:
- PI列表页面可能无法加载数据
- Phase 4.1测试用例可能受影响

**修复方案**:

**文件**: `frontend/src/stores/modules/pi.ts` 或 `frontend/src/stores/modules/planning.ts`

**检查现有方法**:
```typescript
// 检查是否有类似的方法
function fetchPIs() {
  // 实现PI列表获取逻辑
}

// 或使用现有方法
function getPIs() {
  return pis.value
}
```

**修复状态**: ⏳ 待修复

**优先级**: 🔴 高

---

#### 4. 修复Version Store方法错误

**问题描述**:
```
versionStore.getVersionsByProject.value is not a function
```

**影响范围**:
- 项目详情页面无法显示版本列表
- Phase 1.2测试用例可能受影响

**修复方案**:

**文件**: `frontend/src/stores/modules/version.ts`

**检查方法定义**:
```typescript
// 检查是否有getVersionsByProject方法
// 如果存在，检查是否正确导出
// 如果不存在，需要添加

function getVersionsByProject(projectId: string): Version[] {
  return versions.value.filter(v => v.projectIds?.includes(projectId))
}

// 确保在return中正确导出
return {
  // ... 其他方法
  getVersionsByProject, // 不是 getVersionsByProject.value
}
```

**修复状态**: ⏳ 待修复

**优先级**: 🟡 中

---

### 🟡 中优先级（建议修复）

#### 5. 补充Sprint Mock数据

**问题描述**:
- Sprint列表显示0个Sprint
- Phase 7.1测试用例通过但数据为空

**修复方案**:

**文件**: `frontend/src/mock-data/sprints.json` 或创建新文件

**添加Mock数据**:
```json
[
  {
    "id": "sprint-001",
    "code": "SPRINT-001",
    "name": "Sprint 2026-01",
    "piId": "pi-001",
    "startDate": "2026-01-01T00:00:00Z",
    "endDate": "2026-01-14T23:59:59Z",
    "duration": 14,
    "capacity": 100,
    "plannedStoryPoints": 80,
    "completedStoryPoints": 0,
    "status": "planning",
    "teamId": "team-001",
    "teamName": "智能驾驶团队"
  }
]
```

**修复状态**: ⏳ 待修复

**优先级**: 🟡 中

---

#### 6. 补充Task Mock数据

**问题描述**:
- Task列表显示0个Task
- Phase 7.2测试用例通过但数据为空

**修复方案**:

**文件**: `frontend/src/mock-data/tasks.json` 或创建新文件

**添加Mock数据**:
```json
[
  {
    "id": "task-001",
    "code": "TASK-001",
    "title": "实现ACC目标车辆检测算法",
    "mrId": "mr-001",
    "sprintId": "sprint-001",
    "description": "实现ACC功能中的目标车辆检测算法",
    "acceptanceCriteria": "能够准确检测前方车辆",
    "assignee": "user-002",
    "reviewer": "user-001",
    "estimateHours": 16,
    "actualHours": 0,
    "remainingHours": 16,
    "status": "TODO",
    "priority": "P0",
    "startDate": null,
    "endDate": null,
    "blocked": false,
    "dependencies": [],
    "tags": ["ACC", "算法"],
    "type": "feature"
  }
]
```

**修复状态**: ⏳ 待修复

**优先级**: 🟡 中

---

### 🟢 低优先级（可选优化）

#### 7. 优化测试用例稳定性

**问题描述**:
- 部分测试用例依赖特定的等待时间
- Tab切换可能需要更长的等待时间

**优化方案**:
```typescript
// 使用更智能的等待策略
await page.waitForSelector('div[role="tabpanel"]:has-text("Features")', { 
  state: 'visible',
  timeout: 10000 
})
```

**修复状态**: ⏳ 待优化

**优先级**: 🟢 低

---

#### 8. 添加错误处理

**问题描述**:
- 测试用例中缺少详细的错误处理
- 失败时难以定位问题

**优化方案**:
```typescript
try {
  await featureTab.click({ force: true })
} catch (error) {
  console.error('Tab点击失败:', error)
  await page.screenshot({ path: 'error-screenshot.png' })
  throw error
}
```

**修复状态**: ⏳ 待优化

**优先级**: 🟢 低

---

## 🔧 修复步骤

### Step 1: 修复Store方法（高优先级）

1. **修复SSTS Store**
   ```bash
   # 编辑文件
   vim frontend/src/stores/modules/ssts.ts
   
   # 添加getMRsBySSTS方法
   ```

2. **修复PI Store**
   ```bash
   # 检查PI Store文件
   vim frontend/src/stores/modules/pi.ts
   # 或
   vim frontend/src/stores/modules/planning.ts
   
   # 添加或修复fetchPIs方法
   ```

3. **修复Version Store**
   ```bash
   # 编辑文件
   vim frontend/src/stores/modules/version.ts
   
   # 修复getVersionsByProject方法导出
   ```

### Step 2: 补充Mock数据（中优先级）

1. **创建Sprint Mock数据**
   ```bash
   # 创建或编辑文件
   vim frontend/src/mock-data/sprints.json
   
   # 添加Sprint数据
   ```

2. **创建Task Mock数据**
   ```bash
   # 创建或编辑文件
   vim frontend/src/mock-data/tasks.json
   
   # 添加Task数据
   ```

3. **更新数据加载器**
   ```bash
   # 编辑文件
   vim frontend/src/mock-data/initializer.ts
   
   # 添加Sprint和Task的加载逻辑
   ```

### Step 3: 重新执行测试

```bash
cd frontend
npx playwright test e2e-domain-to-pi-planning.spec.ts --project=chromium --reporter=html,list
```

### Step 4: 验证修复

1. 检查测试通过率是否提升
2. 验证Store方法是否正常工作
3. 验证Mock数据是否正确加载

---

## 📊 修复优先级矩阵

| 任务 | 优先级 | 影响范围 | 预计时间 | 状态 |
|------|--------|---------|---------|------|
| Tab选择器修复 | 🔴 高 | 2个测试用例 | 10分钟 | ✅ 已完成 |
| SSTS Store方法 | 🔴 高 | SSTS详情页面 | 30分钟 | ⏳ 待修复 |
| PI Store方法 | 🔴 高 | PI列表页面 | 30分钟 | ⏳ 待修复 |
| Version Store方法 | 🟡 中 | 项目详情页面 | 20分钟 | ⏳ 待修复 |
| Sprint Mock数据 | 🟡 中 | Sprint列表 | 30分钟 | ⏳ 待修复 |
| Task Mock数据 | 🟡 中 | Task列表 | 30分钟 | ⏳ 待修复 |
| 测试稳定性优化 | 🟢 低 | 测试用例 | 1小时 | ⏳ 待优化 |
| 错误处理优化 | 🟢 低 | 测试用例 | 30分钟 | ⏳ 待优化 |

---

## ✅ 修复验证清单

### Store方法修复验证

- [ ] SSTS详情页面可以显示MR列表
- [ ] PI列表页面可以正常加载数据
- [ ] 项目详情页面可以显示版本列表
- [ ] 无控制台错误信息

### Mock数据验证

- [ ] Sprint列表显示Sprint数据
- [ ] Task列表显示Task数据
- [ ] 数据关联关系正确

### 测试用例验证

- [ ] Phase 2.2测试用例通过
- [ ] Phase 8.1测试用例通过
- [ ] 所有Phase 8-10测试用例执行
- [ ] 测试通过率 > 90%

---

## 📝 修复记录

### 2026-01-17

- ✅ **Tab选择器修复**: 已完成
  - 修复了所有Tab选择器，使用`div[role="tab"]`选择器
  - 添加了`force: true`选项确保点击成功

- ⏳ **Store方法修复**: 待执行
  - SSTS Store: `getMRsBySSTS`方法
  - PI Store: `fetchPIs`方法
  - Version Store: `getVersionsByProject`方法

- ⏳ **Mock数据补充**: 待执行
  - Sprint Mock数据
  - Task Mock数据

---

## 🎯 预期结果

修复完成后，预期达到：

- ✅ **测试通过率**: > 90%
- ✅ **Store方法**: 所有方法正常工作
- ✅ **Mock数据**: Sprint和Task数据完整
- ✅ **页面功能**: 所有页面功能正常

---

**修复计划结束**
