# 平台设计差距分析与调整方案

> **分析日期**: 2026-01-17  
> **分析范围**: 导航框架、页面功能、业务流程  
> **对标文档**: feature-implementation/domain-prog-to-pi-plan-v2.md  
> **版本**: V1.0

---

## 📊 一、当前实现与目标差距分析

### 1.1 整体完成度对比

| 业务流程步骤 | 设计完成度 | 实施完成度 | 差距 | 优先级 |
|-------------|----------|----------|------|--------|
| **Step 1: 创建领域项目** | 100% | 100% | ✅ 无差距 | - |
| **Step 2: 从需求池加入Epic** | 100% | 90% | ⚠️ 缺少Epic评审、看板 | P1 |
| **Step 3: Epic拆解Feature** | 100% | 85% | ⚠️ 缺少Feature评审 | P1 |
| **Step 4: Feature编写PRD** | 100% | 60% | 🔴 缺少PRD编辑器 | **P0** |
| **Step 5: Feature拆解SSTS** | 100% | 90% | ⚠️ 缺少SSTS评审 | P1 |
| **Step 6: 规划多PI版本** | 70% | 70% | 🔴 缺少Feature分配工具 | **P0** |
| **Step 7: PI Planning排布** | 85% | 85% | ⚠️ 缺少风险管理、PI回顾 | P1 |

### 1.2 关键缺失功能汇总

#### 🔴 P0级别（关键阻塞）

1. **PRD在线编辑器**
   - **现状**: 仅有PRD数据展示
   - **差距**: 无法在线编写PRD
   - **影响**: Feature编写PRD流程无法完整执行
   - **预计工作量**: 1-2天

2. **Feature批量分配到PI/版本工具**
   - **现状**: 仅有基础版本创建
   - **差距**: 无法批量分配Feature到PI，无容量可视化
   - **影响**: 版本规划效率极低，无法评估容量
   - **预计工作量**: 1-2天

3. **PRD+SSTS批量查看和评审页面**
   - **现状**: 每个单独查看
   - **差距**: 无法批量查看PRD和SSTS内容
   - **影响**: 评审效率低，无法全局把握
   - **预计工作量**: 1天

#### ⚠️ P1级别（重要增强）

4. **Epic/Feature/SSTS评审流程**
   - **现状**: 仅有评审状态字段
   - **差距**: 无评审操作界面和流转机制
   - **预计工作量**: 1天

5. **团队视角的模块需求管理**
   - **现状**: 全局MR列表
   - **差距**: 无团队筛选和权限控制
   - **预计工作量**: 0.5天

6. **流程视角导航** 
   - **现状**: 仅有固有功能导航
   - **差距**: 无流程驱动的导航模式
   - **预计工作量**: 2天

---

## 🎯 二、核心问题分析

### 2.1 需求拆解流程的核心问题

#### 问题1: Epic是输入不可修改，但当前设计允许修改

**现状**:
```typescript
// EpicDetail.vue 中有编辑功能
<el-button @click="handleEdit">编辑Epic</el-button>
```

**用户诉求**:
- Epic来自需求池，评审通过后是只读的
- 只能在需求池中修改，然后重新评审
- 项目中的Epic应该是"快照"，不可修改

**调整方案**:
```typescript
interface Epic {
  id: string;
  source: 'requirement_pool' | 'manual';  // 来源
  poolEpicId?: string;  // 需求池Epic ID
  isReadOnly: boolean;  // 是否只读
  syncStatus: 'synced' | 'outdated';  // 同步状态
}

// 如果来自需求池，Epic在项目中是只读的
if (epic.source === 'requirement_pool') {
  // 显示"在需求池中编辑"按钮
  // 点击跳转到需求池进行编辑
}
```

---

#### 问题2: Feature的PRD拆解到SSTS，缺少批量查看和评审

**现状**:
- Feature详情 → PRD Tab → 查看PRD
- Feature详情 → SSTS Tab → 查看SSTS列表
- 需要多次点击，无法批量查看

**用户诉求**:
1. **批量查看**: 一屏内同时看到PRD内容和拆解的SSTS列表
2. **批量评审**: 可以对一个Feature的PRD+所有SSTS进行整体评审
3. **评审上下文**: 评审时能看到完整上下文（Epic→Feature→PRD→SSTS）

**调整方案**: 新增页面

```
/function/c1-requirement/feature/prd-ssts-review/:featureId

页面布局:
┌──────────────────────────────────────────────────────────┐
│ PRD + SSTS批量评审页面                                    │
├──────────────────────────────────────────────────────────┤
│ ┌─ 上下文信息 ──────────────────────────────────────┐  │
│ │ Epic: [ADAS-E001] L2+自动驾驶                      │  │
│ │ Feature: [ADAS-F001] 车道保持辅助（LKA）           │  │
│ │ 负责人: 张三  状态: 待评审                         │  │
│ └────────────────────────────────────────────────┘  │
│                                                          │
│ ┌─ 左侧：PRD内容 (60%) ─────────────────────────────┐  │
│ │ PRD标题: LKA功能产品需求文档                        │  │
│ │                                                      │  │
│ │ 1. 功能概述                                          │  │
│ │ 实现车道保持辅助功能...                              │  │
│ │                                                      │  │
│ │ 2. 用户场景                                          │  │
│ │ ...                                                  │  │
│ │                                                      │  │
│ │ 3. 功能需求                                          │  │
│ │ ...                                                  │  │
│ │                                                      │  │
│ │ (支持滚动，完整PRD内容)                              │  │
│ │                                                      │  │
│ └────────────────────────────────────────────────┘  │
│                                                          │
│ ┌─ 右侧：SSTS列表 (40%) ────────────────────────────┐  │
│ │ 拆解的SSTS (3个)                                     │  │
│ │                                                      │  │
│ │ ☑ [System] ADAS-S001 车道线检测系统需求             │  │
│ │   描述: 系统应能检测车道线...                       │  │
│ │   验收标准: 3个                                      │  │
│ │   [展开查看详情 ▼]                                  │  │
│ │                                                      │  │
│ │ ☑ [Technical] ADAS-S002 车道保持控制技术需求        │  │
│ │   描述: 实现车道保持控制算法...                     │  │
│ │   验收标准: 4个                                      │  │
│ │   [展开查看详情 ▼]                                  │  │
│ │                                                      │  │
│ │ ☑ [Safety] ADAS-S003 LKA安全需求 (ASIL-D)          │  │
│ │   描述: LKA功能应满足ASIL-D...                      │  │
│ │   验收标准: 5个                                      │  │
│ │   [展开查看详情 ▼]                                  │  │
│ │                                                      │  │
│ └────────────────────────────────────────────────┘  │
│                                                          │
│ ┌─ 评审操作区 ──────────────────────────────────────┐  │
│ │ 评审意见:                                            │  │
│ │ ┌──────────────────────────────────────────────┐  │  │
│ │ │ • SSTS拆解完整，覆盖了PRD的所有需求             │  │
│ │ │ • 安全需求ASIL-D等级合理                        │  │
│ │ │ • 建议补充车道线检测的性能需求                  │  │
│ │ └──────────────────────────────────────────────┘  │  │
│ │                                                      │  │
│ │ 评审结果:                                            │  │
│ │ ○ 通过  ● 通过(有条件)  ○ 拒绝                     │  │
│ │                                                      │  │
│ │ [提交评审] [保存草稿] [返回]                        │  │
│ └────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

**关键功能**:
1. 一屏显示PRD完整内容 + SSTS列表
2. 支持批量选择SSTS进行评审
3. 评审结果同时更新Feature和所有SSTS的状态
4. 评审历史记录

---

### 2.2 模块需求管理的团队视角问题

#### 问题3: 缺少团队视角的MR管理

**现状**:
- MR列表是全局的
- 没有按团队筛选
- 没有权限控制

**用户诉求**:
1. **团队视角**: 团队只看到自己管理的1-n个模块的MR
2. **SSTS拆解**: 可以选择特性需求的SSTS拆解为MR
3. **批量操作**: 批量review、评审SSTS对应的MR

**调整方案**: 新增团队工作台

```
/workspace/team/:teamId/module-requirements

页面布局:
┌──────────────────────────────────────────────────────────┐
│ 团队工作台 - 模块需求管理                                 │
│ 团队: 智驾团队 (ADAS)  负责人: 李四                      │
├──────────────────────────────────────────────────────────┤
│ ┌─ 我的模块 ─────────────────────────────────────────┐  │
│ │ ☑ M01-车道保持  ☑ M02-自适应巡航  ☑ M03-自动泊车  │  │
│ │ (可多选，默认全选)                                   │  │
│ └────────────────────────────────────────────────┘  │
│                                                          │
│ ┌─ 视图切换 ─────────────────────────────────────────┐  │
│ │ ⚫ MR列表视图  ○ SSTS拆解视图  ○ 看板视图           │  │
│ └────────────────────────────────────────────────┘  │
│                                                          │
│ ┌─ MR列表 (仅显示我的模块) ──────────────────────────┐  │
│ │ 筛选: [Feature ▾] [SSTS ▾] [状态 ▾] [优先级 ▾]    │  │
│ │                                                      │  │
│ │ ☐ MR-001 车道线检测算法                             │  │
│ │    Feature: ADAS-F001 | SSTS: ADAS-S001            │  │
│ │    状态: 待评审 | 估算: 13SP | 负责人: 张三        │  │
│ │    [查看] [评审] [编辑]                            │  │
│ │                                                      │  │
│ │ ☐ MR-002 车道保持控制器                             │  │
│ │    Feature: ADAS-F001 | SSTS: ADAS-S002            │  │
│ │    状态: 开发中 | 估算: 21SP | 负责人: 李四        │  │
│ │    [查看] [进度更新]                                │  │
│ │                                                      │  │
│ │ (仅显示团队负责模块的MR)                            │  │
│ │                                                      │  │
│ │ [批量评审] [批量分配] [导出]                        │  │
│ └────────────────────────────────────────────────┘  │
│                                                          │
│ ┌─ SSTS拆解视图 (可选) ──────────────────────────────┐  │
│ │ 选择Feature: [ADAS-F001 车道保持辅助 ▾]             │  │
│ │                                                      │  │
│ │ 该Feature的SSTS列表:                                 │  │
│ │ ☐ ADAS-S001 车道线检测系统需求 (3个MR)              │  │
│ │ ☐ ADAS-S002 车道保持控制技术需求 (2个MR)            │  │
│ │ ☑ ADAS-S003 LKA安全需求 (0个MR) ← 选中待拆解       │  │
│ │                                                      │  │
│ │ 拆解为MR:                                            │  │
│ │ MR标题: [LKA安全监控模块                         ]  │  │
│ │ 所属模块: [M01-车道保持 ▾]                          │  │
│ │ 负责人: [张三 ▾]                                    │  │
│ │ 估算: [8] SP                                         │  │
│ │                                                      │  │
│ │ [保存并继续] [取消]                                 │  │
│ └────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

**关键功能**:
1. 基于团队的权限过滤（自动过滤）
2. 支持SSTS选择和MR拆解
3. 批量操作（评审、分配、更新状态）
4. 看板视图（按状态分组）

**数据模型增强**:
```typescript
interface Team {
  id: string;
  name: string;
  modules: string[];  // 负责的模块ID列表
  members: TeamMember[];
}

interface ModuleRequirement {
  id: string;
  moduleId: string;  // 所属模块
  teamId: string;    // 负责团队
  // ... 其他字段
}

// 权限控制
function canAccessMR(user: User, mr: ModuleRequirement): boolean {
  const userTeams = getUserTeams(user);
  return userTeams.some(team => 
    team.modules.includes(mr.moduleId) || 
    team.id === mr.teamId
  );
}
```

---

### 2.3 流程视角导航问题

#### 问题4: 当前只有固有功能视角，缺少流程驱动视角

**现状**:
- 导航设计中有"流程驱动"模式概念
- 但未实际实现流程导航
- 用户需要跨多个功能模块完成一个流程

**用户诉求**:
构建多条流程，如：
1. **项目规划流程**: 创建项目 → 版本规划 → PI规划
2. **PI Planning流程**: PI创建 → 目标设定 → Feature分配 → 容量规划 → PI承诺
3. **需求拆解流程**: Epic → Feature → PRD → SSTS → MR
4. **团队Backlog计划流程**: Sprint规划 → Task分配 → 开发执行
5. **发布流程**: 测试 → 构建 → 发布 → 验收

**关键特征**:
- 流程有范围（限定在某个项目/PI/Feature内）
- 流程有始有终（完成后关闭）
- 流程有步骤和进度（可视化当前处于哪一步）

**调整方案**: 实现流程驱动导航

```typescript
// 1. 流程定义
interface ProcessDefinition {
  id: string;
  name: string;  // 如"PI Planning流程"
  icon: string;
  category: 'planning' | 'development' | 'test' | 'release';
  steps: ProcessStep[];
  roles: string[];  // 参与角色
}

interface ProcessStep {
  id: string;
  name: string;  // 如"PI目标设定"
  page: string;  // 对应的页面路由
  status: 'todo' | 'in_progress' | 'done' | 'skipped';
  dependencies: string[];  // 依赖的步骤
  estimatedDuration: number;  // 预计耗时(分钟)
}

// 2. 流程实例
interface ProcessInstance {
  id: string;
  definitionId: string;
  name: string;  // 如"2024.4 PI Planning"
  scope: {  // 流程范围
    type: 'project' | 'pi' | 'feature' | 'sprint';
    id: string;
  };
  currentStep: string;
  progress: number;  // 0-100
  startTime: Date;
  endTime?: Date;
  status: 'active' | 'paused' | 'completed' | 'cancelled';
  owner: string;
  participants: string[];
}

// 3. 流程导航组件
<template>
  <div class="process-navigation">
    <!-- 我的活跃流程 -->
    <div class="active-processes">
      <h3>我的活跃流程 (3个)</h3>
      
      <!-- 流程卡片 -->
      <div class="process-card" @click="enterProcess(process)">
        <div class="process-header">
          <span class="process-icon">🎯</span>
          <span class="process-name">2024.4 PI Planning</span>
          <el-tag type="warning">进行中</el-tag>
        </div>
        
        <div class="process-progress">
          <el-progress :percentage="60" />
          <span>6/10步完成</span>
        </div>
        
        <div class="current-step">
          当前: Feature分配 (2小时前更新)
        </div>
        
        <div class="process-actions">
          <el-button size="small" @click.stop="continueProcess">继续</el-button>
          <el-button size="small" type="info" @click.stop="viewProcess">查看</el-button>
        </div>
      </div>
      
      <!-- 更多流程... -->
    </div>
    
    <!-- 可启动的流程模板 -->
    <div class="process-templates">
      <h3>启动新流程</h3>
      
      <el-button @click="startProcess('pi-planning')">
        <i class="icon-pi"></i> PI Planning流程
      </el-button>
      
      <el-button @click="startProcess('requirement-decompose')">
        <i class="icon-req"></i> 需求拆解流程
      </el-button>
      
      <el-button @click="startProcess('sprint-planning')">
        <i class="icon-sprint"></i> Sprint规划流程
      </el-button>
    </div>
  </div>
</template>
```

**流程页面布局**:
```
┌──────────────────────────────────────────────────────────┐
│ 流程: 2024.4 PI Planning                    [退出流程]  │
├──────────────────────────────────────────────────────────┤
│ ┌─ 流程进度 ──────────────────────────────────────────┐│
│ │ ●────●────●────●────○────○────○────○────○────○    ││
│ │ PI   目标  Feature 容量  负载  Sprint PI    依赖  承诺││
│ │ 创建 设定   分配   规划  均衡  规划  Board  识别      ││
│ │ ✓    ✓     ✓     ✓    ▶          (当前步骤)       ││
│ │                                                      ││
│ │ 进度: 40% (4/10步完成)  预计剩余: 3小时              ││
│ └────────────────────────────────────────────────┘││
│                                                          │
│ ┌─ 当前步骤：负载均衡 ──────────────────────────────┐││
│ │ (嵌入对应的页面内容)                                ││
│ │                                                      ││
│ │ [负载均衡页面的实际内容...]                         ││
│ │                                                      ││
│ └────────────────────────────────────────────────┘││
│                                                          │
│ ┌─ 流程操作 ────────────────────────────────────────┐││
│ │ [◀ 上一步: 容量规划] [保存并继续] [下一步: Sprint规划 ▶]││
│ │ [暂停流程] [流程概览]                               ││
│ └────────────────────────────────────────────────┘││
└──────────────────────────────────────────────────────────┘
```

**关键特性**:
1. **流程隔离**: 进入流程后，导航聚焦在流程步骤上
2. **上下文保持**: 流程实例保存所有中间状态
3. **步骤导航**: 清晰显示当前步骤和可前进/后退
4. **流程暂停/恢复**: 可以暂停流程，稍后继续
5. **流程追踪**: 记录每个步骤的完成时间和操作人

---

### 2.4 权限和范围控制问题

#### 问题5: 缺少基于角色的范围过滤

**现状**:
- 所有数据全局可见
- 没有基于角色和范围的过滤

**用户诉求**:
1. **PO视角**: PO负责城市NOA产品，默认看到该产品范围的内容
   - PI规划: 该产品相关的PI
   - Feature: 该产品的Feature
   - SSTS: 该产品Feature的SSTS
   
2. **团队视角**: 团队负责某几个模块
   - Feature: 包含团队模块的Feature
   - MR: 团队负责模块的MR
   - Sprint: 团队的Sprint和Task

**调整方案**: 实现范围过滤器

```typescript
// 1. 用户范围定义
interface UserScope {
  userId: string;
  role: 'PO' | 'DL' | 'DEV' | 'QA' | 'PM' | 'TPM';
  scopes: Scope[];
}

interface Scope {
  type: 'project' | 'product' | 'module' | 'team';
  id: string;
  name: string;
  permission: 'read' | 'write' | 'admin';
}

// 2. 全局范围过滤器
<template>
  <div class="scope-selector" v-if="userHasMultipleScopes">
    <!-- 顶部导航栏中的范围选择器 -->
    <el-select v-model="currentScope" placeholder="选择工作范围">
      <el-option-group label="我的产品">
        <el-option 
          v-for="product in myProducts" 
          :key="product.id"
          :label="product.name"
          :value="`product:${product.id}`"
        />
      </el-option-group>
      
      <el-option-group label="我的团队">
        <el-option 
          v-for="team in myTeams" 
          :key="team.id"
          :label="team.name"
          :value="`team:${team.id}`"
        />
      </el-option-group>
      
      <el-option-group label="我的项目">
        <el-option 
          v-for="project in myProjects" 
          :key="project.id"
          :label="project.name"
          :value="`project:${project.id}`"
        />
      </el-option-group>
    </el-select>
  </div>
</template>

// 3. 数据自动过滤
// 在Store中自动根据当前范围过滤数据
const featureStore = useFeatureStore();

// 获取Feature列表时自动应用范围过滤
const features = computed(() => {
  const scope = userStore.currentScope;
  
  if (!scope) {
    return featureStore.allFeatures;  // 无范围限制（管理员）
  }
  
  if (scope.type === 'product') {
    return featureStore.allFeatures.filter(f => 
      f.productId === scope.id
    );
  }
  
  if (scope.type === 'team') {
    return featureStore.allFeatures.filter(f =>
      f.modules.some(m => scope.teamModules.includes(m))
    );
  }
  
  return featureStore.allFeatures;
});
```

**关键特性**:
1. **自动范围过滤**: 基于当前选择的范围自动过滤数据
2. **范围切换**: 顶部导航栏快速切换工作范围
3. **范围提示**: 页面显示当前工作范围
4. **权限控制**: 基于范围的操作权限

**界面示例**:
```
┌──────────────────────────────────────────────────────────┐
│ ┌─ 顶部导航栏 ────────────────────────────────────────┐ │
│ │ [Logo] | 当前范围: 城市NOA产品 ▼ | [搜索] [通知] [用户]│ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ ┌─ 页面标题区 ────────────────────────────────────────┐ │
│ │ 📝 Feature列表                                       │ │
│ │ 🔒 工作范围: 城市NOA产品                            │ │
│ │    (仅显示该产品相关的Feature)                      │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ (Feature列表，已自动过滤为城市NOA产品相关)             │
└──────────────────────────────────────────────────────────┘
```

---

## 🛠️ 三、设计调整方案

### 3.1 需求拆解流程优化方案

#### 方案3.1.1: Epic只读控制

**实施步骤**:
1. 在Epic数据模型中增加`source`和`isReadOnly`字段
2. 从需求池导入的Epic自动标记为只读
3. Epic详情页根据`isReadOnly`字段控制编辑按钮显示
4. 提供"在需求池中编辑"跳转链接

**代码示例**:
```vue
<template>
  <div class="epic-detail">
    <!-- 编辑按钮根据只读状态控制 -->
    <el-button 
      v-if="!epic.isReadOnly"
      type="primary"
      @click="handleEdit"
    >
      编辑Epic
    </el-button>
    
    <el-button
      v-else
      type="info"
      @click="jumpToRequirementPool"
    >
      在需求池中编辑
    </el-button>
    
    <el-tag v-if="epic.isReadOnly" type="warning">
      只读 (来自需求池)
    </el-tag>
  </div>
</template>
```

---

#### 方案3.1.2: PRD+SSTS批量查看和评审页面

**新增页面**:
```
/function/c1-requirement/feature/:featureId/prd-ssts-review
```

**实施步骤**:
1. 创建`PRDSSTSReview.vue`组件
2. 左侧60%显示PRD完整内容（富文本）
3. 右侧40%显示SSTS列表（可展开折叠）
4. 底部评审操作区（意见、结果、提交）
5. 集成到Feature详情页的Tab或独立路由

**核心功能**:
- 一屏查看PRD+SSTS
- 支持SSTS展开查看详情
- 批量勾选SSTS进行评审
- 评审结果同步更新所有相关状态

---

#### 方案3.1.3: PRD在线编辑器

**新增页面**:
```
/function/c1-requirement/feature/:featureId/prd/edit
```

**技术方案**:
```typescript
// 使用TipTap富文本编辑器
import { useEditor, EditorContent } from '@tiptap/vue-3';
import StarterKit from '@tiptap/starter-kit';
import Image from '@tiptap/extension-image';
import Link from '@tiptap/extension-link';
import Table from '@tiptap/extension-table';

const editor = useEditor({
  extensions: [
    StarterKit,
    Image,
    Link,
    Table,
  ],
  content: prdStore.currentPRD.content,
  onUpdate: ({ editor }) => {
    autoSave();  // 自动保存
  },
});

// 自动保存（防抖2秒）
const autoSave = debounce(() => {
  prdStore.saveDraft(featureId, editor.value.getHTML());
}, 2000);
```

**关键特性**:
- 富文本编辑（标题、列表、表格、图片、链接）
- 自动保存（每2秒）
- 草稿管理
- 版本历史
- Markdown导入/导出
- PRD模板（预设10+模板）

---

### 3.2 团队视角MR管理方案

#### 方案3.2.1: 团队工作台页面

**新增页面**:
```
/workspace/team/:teamId/module-requirements
```

**实施步骤**:
1. 创建`TeamModuleRequirements.vue`组件
2. 实现模块选择器（多选，默认全选团队负责的模块）
3. MR列表自动根据模块过滤
4. 增加SSTS拆解视图（可选SSTS拆解为MR）
5. 实现批量操作（评审、分配、状态更新）
6. 看板视图（按状态分组）

**权限控制**:
```typescript
// 在路由守卫中检查团队权限
router.beforeEach((to, from, next) => {
  if (to.path.startsWith('/workspace/team/')) {
    const teamId = to.params.teamId;
    const user = userStore.currentUser;
    
    if (!user.teams.includes(teamId)) {
      // 无权访问该团队工作台
      next({ path: '/403' });
    } else {
      next();
    }
  } else {
    next();
  }
});

// 在Store中自动过滤MR
const teamMRs = computed(() => {
  const team = teamStore.currentTeam;
  return mrStore.allMRs.filter(mr =>
    team.modules.includes(mr.moduleId)
  );
});
```

---

### 3.3 流程驱动导航方案

#### 方案3.3.1: 流程定义和实例管理

**数据结构**:
```typescript
// 1. 预定义流程模板
const processTemplates: ProcessDefinition[] = [
  {
    id: 'pi-planning',
    name: 'PI Planning流程',
    icon: 'icon-pi',
    category: 'planning',
    steps: [
      { 
        id: 'pi-create', 
        name: 'PI创建', 
        page: '/function/c0-project/pi/create',
        estimatedDuration: 30,
      },
      { 
        id: 'pi-objectives', 
        name: 'PI目标设定', 
        page: '/function/c3/pi/:piId/objectives',
        estimatedDuration: 60,
      },
      { 
        id: 'feature-allocation', 
        name: 'Feature分配', 
        page: '/function/c3/pi/:piId/feature-allocation',
        estimatedDuration: 90,
        dependencies: ['pi-objectives'],
      },
      // ... 更多步骤
    ],
    roles: ['PM', 'TPM', 'DL'],
  },
  {
    id: 'requirement-decompose',
    name: '需求拆解流程',
    icon: 'icon-decompose',
    category: 'development',
    steps: [
      { id: 'epic-create', name: 'Epic导入', page: '/function/c1/epic/import' },
      { id: 'feature-decompose', name: 'Feature拆解', page: '/function/c1/epic/:epicId/decompose' },
      { id: 'prd-write', name: 'PRD编写', page: '/function/c1/feature/:featureId/prd/edit' },
      { id: 'ssts-decompose', name: 'SSTS拆解', page: '/function/c1/feature/:featureId/ssts-decompose' },
      { id: 'prd-ssts-review', name: 'PRD+SSTS评审', page: '/function/c1/feature/:featureId/prd-ssts-review' },
    ],
    roles: ['PO', 'SE'],
  },
];
```

---

#### 方案3.3.2: 流程导航UI

**左侧导航增强**:
```vue
<template>
  <div class="side-navigation">
    <!-- 模式切换器 -->
    <el-segmented v-model="navMode" :options="navModes" />
    
    <!-- 流程驱动模式 -->
    <div v-if="navMode === 'process'" class="process-mode">
      <!-- 我的活跃流程 -->
      <div class="my-processes">
        <h3>我的流程 (3个进行中)</h3>
        
        <div 
          v-for="process in myActiveProcesses" 
          :key="process.id"
          class="process-item"
          :class="{ active: currentProcess?.id === process.id }"
          @click="enterProcess(process)"
        >
          <div class="process-header">
            <i :class="process.icon"></i>
            <span>{{ process.name }}</span>
            <el-progress 
              type="circle" 
              :width="30" 
              :percentage="process.progress" 
              :show-text="false"
            />
          </div>
          
          <div class="process-info">
            <span class="current-step">{{ process.currentStepName }}</span>
            <span class="time">{{ process.lastUpdateTime }}</span>
          </div>
        </div>
      </div>
      
      <!-- 启动新流程 -->
      <div class="start-process">
        <h3>启动新流程</h3>
        
        <el-button
          v-for="template in processTemplates"
          :key="template.id"
          @click="startProcess(template)"
        >
          <i :class="template.icon"></i>
          {{ template.name }}
        </el-button>
      </div>
      
      <!-- 已完成流程（可折叠） -->
      <el-collapse>
        <el-collapse-item title="已完成流程 (10个)">
          <div 
            v-for="process in myCompletedProcesses" 
            :key="process.id"
            class="process-item completed"
          >
            {{ process.name }}
            <el-tag type="success">已完成</el-tag>
          </div>
        </el-collapse-item>
      </el-collapse>
    </div>
    
    <!-- 固有功能模式（现有导航） -->
    <div v-else-if="navMode === 'function'" class="function-mode">
      <!-- 现有的功能导航 -->
    </div>
    
    <!-- 工作台模式 -->
    <div v-else-if="navMode === 'workspace'" class="workspace-mode">
      <!-- 工作台导航 -->
    </div>
  </div>
</template>
```

---

#### 方案3.3.3: 流程页面容器

**流程容器组件**:
```vue
<template>
  <div class="process-container">
    <!-- 流程进度条 -->
    <div class="process-progress-bar">
      <div 
        v-for="(step, index) in processSteps" 
        :key="step.id"
        class="step-node"
        :class="{
          completed: index < currentStepIndex,
          active: index === currentStepIndex,
          future: index > currentStepIndex,
        }"
      >
        <div class="step-dot">
          <i v-if="index < currentStepIndex" class="el-icon-check"></i>
          <i v-else-if="index === currentStepIndex" class="el-icon-edit"></i>
          <span v-else>{{ index + 1 }}</span>
        </div>
        <div class="step-label">{{ step.name }}</div>
      </div>
    </div>
    
    <!-- 当前步骤内容 -->
    <div class="step-content">
      <router-view />
    </div>
    
    <!-- 流程导航按钮 -->
    <div class="process-nav-buttons">
      <el-button 
        :disabled="!canGoBack"
        @click="goToPreviousStep"
      >
        ◀ 上一步: {{ previousStepName }}
      </el-button>
      
      <el-button-group>
        <el-button @click="saveProcess">保存进度</el-button>
        <el-button @click="pauseProcess">暂停流程</el-button>
      </el-button-group>
      
      <el-button 
        type="primary"
        :disabled="!canGoNext"
        @click="goToNextStep"
      >
        下一步: {{ nextStepName }} ▶
      </el-button>
    </div>
  </div>
</template>
```

---

### 3.4 范围过滤和权限控制方案

#### 方案3.4.1: 范围选择器

**顶部导航栏增强**:
```vue
<template>
  <div class="top-navigation-bar">
    <div class="left-section">
      <div class="logo">Auto-RD平台</div>
      
      <!-- 范围选择器（核心增强） -->
      <div class="scope-selector" v-if="userHasMultipleScopes">
        <el-select 
          v-model="currentScopeId" 
          placeholder="选择工作范围"
          @change="handleScopeChange"
        >
          <el-option-group 
            v-for="group in scopeGroups" 
            :key="group.label"
            :label="group.label"
          >
            <el-option
              v-for="scope in group.scopes"
              :key="scope.id"
              :label="scope.name"
              :value="scope.id"
            >
              <span class="scope-icon">{{ scope.icon }}</span>
              <span class="scope-name">{{ scope.name }}</span>
              <el-tag v-if="scope.permission === 'admin'" size="small">管理员</el-tag>
            </el-option>
          </el-option-group>
          
          <el-option value="all" v-if="userIsAdmin">
            <span class="scope-icon">🌐</span>
            <span>全部范围（管理员视图）</span>
          </el-option>
        </el-select>
      </div>
      
      <!-- 如果只有一个范围，显示为标签 -->
      <div class="scope-label" v-else-if="userHasSingleScope">
        <el-tag type="info">
          <i :class="currentScope.icon"></i>
          {{ currentScope.name }}
        </el-tag>
      </div>
    </div>
    
    <!-- ... 其他顶部导航元素 ... -->
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { useUserStore } from '@/stores/user';

const userStore = useUserStore();

const scopeGroups = computed(() => [
  {
    label: '我的产品',
    scopes: userStore.myProducts.map(p => ({
      id: `product:${p.id}`,
      name: p.name,
      icon: '📦',
      type: 'product',
      permission: p.permission,
    })),
  },
  {
    label: '我的团队',
    scopes: userStore.myTeams.map(t => ({
      id: `team:${t.id}`,
      name: t.name,
      icon: '👥',
      type: 'team',
      permission: t.permission,
    })),
  },
  {
    label: '我的项目',
    scopes: userStore.myProjects.map(p => ({
      id: `project:${p.id}`,
      name: p.name,
      icon: '📋',
      type: 'project',
      permission: p.permission,
    })),
  },
]);

function handleScopeChange(scopeId: string) {
  userStore.setCurrentScope(scopeId);
  // 自动刷新当前页面数据
  router.go(0);
}
</script>
```

---

#### 方案3.4.2: 自动数据过滤

**在Store中实现自动过滤**:
```typescript
// stores/feature.ts
import { defineStore } from 'pinia';
import { useUserStore } from './user';

export const useFeatureStore = defineStore('feature', () => {
  const userStore = useUserStore();
  
  // 所有Feature（原始数据）
  const allFeatures = ref<Feature[]>([]);
  
  // 基于范围过滤的Feature（自动计算）
  const features = computed(() => {
    const scope = userStore.currentScope;
    
    // 管理员或无范围限制
    if (!scope || scope.id === 'all') {
      return allFeatures.value;
    }
    
    // 产品范围
    if (scope.type === 'product') {
      return allFeatures.value.filter(f => 
        f.productId === scope.productId ||
        f.products.includes(scope.productId)
      );
    }
    
    // 团队范围（通过模块关联）
    if (scope.type === 'team') {
      const teamModules = scope.modules;
      return allFeatures.value.filter(f =>
        f.modules.some(m => teamModules.includes(m))
      );
    }
    
    // 项目范围
    if (scope.type === 'project') {
      return allFeatures.value.filter(f =>
        f.projectId === scope.projectId
      );
    }
    
    return allFeatures.value;
  });
  
  return {
    allFeatures,
    features,  // 对外暴露的是自动过滤后的
  };
});
```

---

## 📋 四、实施优先级和工作量估算

### 4.1 优先级分级

| 优先级 | 功能 | 工作量 | 预计完成时间 |
|-------|------|--------|-------------|
| **P0** | PRD在线编辑器 | 1-2天 | 2026-01-18~19 |
| **P0** | PRD+SSTS批量查看评审页面 | 1天 | 2026-01-19 |
| **P0** | Feature批量分配到PI工具 | 1-2天 | 2026-01-20~21 |
| **P1** | Epic只读控制 | 0.5天 | 2026-01-21 |
| **P1** | Epic/Feature/SSTS评审流程 | 1天 | 2026-01-22 |
| **P1** | 团队视角MR管理页面 | 1天 | 2026-01-22 |
| **P1** | 流程驱动导航实现 | 2天 | 2026-01-23~24 |
| **P1** | 范围选择器和自动过滤 | 1天 | 2026-01-24 |

**总工作量**: 8.5-10.5天

---

### 4.2 实施路线图

```
Week 1 (P0关键功能):
├─ Day 1: PRD在线编辑器（TipTap集成、自动保存）
├─ Day 2: PRD在线编辑器（模板管理、版本历史）
├─ Day 3: PRD+SSTS批量查看评审页面
├─ Day 4: Feature分配工具（拖拽、容量可视化）
└─ Day 5: Feature分配工具（冲突检测、批量操作）

Week 2 (P1增强功能):
├─ Day 6: Epic只读控制 + 评审流程基础
├─ Day 7: 评审流程完善（状态流转、通知）
├─ Day 8: 团队视角MR管理页面
├─ Day 9: 流程驱动导航（流程定义、实例管理）
├─ Day 10: 流程驱动导航（流程容器、进度控制）
└─ Day 11: 范围选择器和自动过滤
```

---

## 🔄 五、与现有设计的兼容性

### 5.1 导航框架兼容性

**现有设计**:
- 三种导航模式：流程驱动、固有功能、工作台
- 已有完整的导航体系定义

**调整方案**:
- ✅ 完全兼容现有导航框架
- ✅ "流程驱动"模式从概念变为实际实现
- ✅ 保留"固有功能"和"工作台"模式
- ✅ 增强模式切换的流畅性

---

### 5.2 页面设计兼容性

**现有设计**:
- Feature拆解页面（C1-F07）
- SSTS拆解页面（C1-F14）
- 各类Detail页面

**调整方案**:
- ✅ 保留现有页面，不做破坏性修改
- ✅ 新增PRD+SSTS批量查看评审页面（补充）
- ✅ 新增团队工作台页面（补充）
- ✅ 增强Feature详情页的Tab（增加PRD编辑Tab）

---

### 5.3 数据模型兼容性

**现有模型**:
```typescript
interface Epic { id, name, description, ... }
interface Feature { id, epicId, name, prd, sstsList, ... }
interface SSTS { id, featureId, name, ... }
interface MR { id, sstsId, name, ... }
```

**调整方案**:
- ✅ 向后兼容，只增加字段，不删除字段
- ✅ 新增字段都有默认值
- ✅ 使用Optional字段避免破坏现有逻辑

```typescript
// 增强后的模型
interface Epic {
  // ... 现有字段
  source?: 'requirement_pool' | 'manual';  // 新增
  poolEpicId?: string;  // 新增
  isReadOnly?: boolean;  // 新增，默认false
}

interface Feature {
  // ... 现有字段
  reviewStatus?: 'pending' | 'approved' | 'rejected';  // 新增
  reviewComments?: ReviewComment[];  // 新增
}
```

---

## ✅ 六、验收标准

### 6.1 功能验收标准

#### P0功能

1. **PRD在线编辑器**
   - [ ] 支持富文本编辑（标题、列表、表格、图片、链接）
   - [ ] 自动保存（2秒防抖）
   - [ ] 草稿管理（保存/恢复草稿）
   - [ ] 版本历史（查看/对比/恢复）
   - [ ] 模板管理（至少5个预设模板）
   - [ ] Markdown导入导出

2. **PRD+SSTS批量查看评审**
   - [ ] 一屏显示PRD完整内容 + SSTS列表
   - [ ] SSTS可展开折叠查看详情
   - [ ] 支持批量勾选SSTS
   - [ ] 评审意见输入和提交
   - [ ] 评审结果更新所有相关状态
   - [ ] 评审历史记录

3. **Feature批量分配工具**
   - [ ] 版本/PI时间线视图
   - [ ] Feature卡片拖拽分配
   - [ ] 容量可视化（进度条）
   - [ ] 冲突检测和预警
   - [ ] 批量操作（分配/取消分配）

#### P1功能

4. **Epic只读控制**
   - [ ] 来自需求池的Epic标记为只读
   - [ ] 只读Epic不显示编辑按钮
   - [ ] 提供"在需求池中编辑"跳转

5. **评审流程**
   - [ ] Epic/Feature/SSTS支持评审状态管理
   - [ ] 评审操作界面（提交评审/通过/拒绝）
   - [ ] 评审意见列表
   - [ ] 评审通知

6. **团队视角MR管理**
   - [ ] 基于团队的MR列表自动过滤
   - [ ] 模块选择器（多选）
   - [ ] SSTS拆解为MR功能
   - [ ] 批量操作（评审/分配/状态更新）
   - [ ] 看板视图

7. **流程驱动导航**
   - [ ] 流程模板定义（至少3个）
   - [ ] 流程实例管理（启动/暂停/恢复/完成）
   - [ ] 流程进度可视化
   - [ ] 流程步骤导航
   - [ ] 流程上下文保持

8. **范围选择器**
   - [ ] 顶部导航栏范围选择器
   - [ ] 支持产品/团队/项目范围
   - [ ] 数据自动根据范围过滤
   - [ ] 范围切换无缝

---

### 6.2 性能验收标准

- [ ] PRD编辑器加载 < 1秒
- [ ] PRD自动保存响应 < 500ms
- [ ] Feature分配拖拽响应 < 100ms
- [ ] 范围切换页面刷新 < 2秒
- [ ] 支持100+Feature的拖拽分配

---

### 6.3 用户体验验收标准

- [ ] 操作流畅，无卡顿
- [ ] 加载状态有Loading提示
- [ ] 操作反馈及时（Toast/Message）
- [ ] 关键操作有确认（Dialog）
- [ ] 错误提示友好明确
- [ ] 帮助文档完善

---

## 📚 七、相关文档

### 7.1 参考文档
- [feature-implementation/domain-prog-to-pi-plan-v2.md](../feature-implementation/domain-prog-to-pi-plan-v2.md) - 实施进度
- [prototype-framework/导航框架完整设计方案.md](../prototype-framework/导航框架完整设计方案.md) - 导航设计
- [page-design/总体设计进度报告.md](./总体设计进度报告.md) - 设计进度

### 7.2 设计文档
- [C1-F07-Feature拆解.md](./C1-需求管理/02-Feature管理/C1-F07-Feature拆解.md)
- [C1-F14-SSTS拆解.md](./C1-需求管理/03-SSTS管理/C1-F14-SSTS拆解.md)
- [C3-F02-Feature分配.md](./C3-规划协调/01-版本规划/C3-F02-Feature分配.md)

---

**文档版本**: V1.0  
**最后更新**: 2026-01-17  
**状态**: 待评审  
**下一步**: 评审通过后开始P0功能实施
