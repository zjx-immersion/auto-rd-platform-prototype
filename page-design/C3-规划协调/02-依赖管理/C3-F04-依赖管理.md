# C3-F04: 依赖管理

> **功能编号**: C3-F04
> **功能名称**: 依赖管理
> **主要用户**: DL（开发负责人）、Scrum Master、RTE（发布火车工程师）
> **页面类型**: 列表页 + 可视化页
> **优先级**: P0
> **价值流阶段**: S4-项目立项、S5-迭代开发

---

## 一、功能概述

### 1.1 功能描述
提供依赖关系的识别、可视化、跟踪和协调功能，支持MR级别和任务级别的依赖管理，支持跨团队依赖协调。

### 1.2 业务价值
- 识别和管理依赖关系
- 可视化依赖网络
- 及时发现依赖风险
- 协调跨团队依赖
- 避免依赖阻塞

### 1.3 使用场景
- PI规划时识别依赖
- Sprint规划时确认依赖
- 日常开发中跟踪依赖
- 跨团队依赖协调
- 依赖风险管理

### 1.4 依赖类型说明

**依赖类型**:
- **FS (Finish-to-Start)**: A完成后B才能开始（最常见）
- **SS (Start-to-Start)**: A开始后B才能开始
- **FF (Finish-to-Finish)**: A完成后B才能完成
- **SF (Start-to-Finish)**: A开始后B才能完成（较少见）

**依赖范围**:
- **团队内依赖**: 同一团队内的MR/任务依赖
- **跨团队依赖**: 不同团队间的MR/任务依赖
- **跨PI依赖**: 不同PI间的依赖

---

## 二、页面布局

### 2.1 依赖管理主页

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ 面包屑: 首页 > 项目管理 > PRJ-2025-001 > PI-1 > 依赖管理                                               │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 依赖管理                                                                                                │
│                                                                                                         │
│ [依赖列表] [依赖图] [依赖矩阵] [跨团队依赖] [风险依赖]                                                 │
│                                                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ 依赖概览                                                                                            │ │
│ │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│ │ │ 总依赖: 45个  |  团队内: 32个  |  跨团队: 13个  |  风险依赖: 5个  |  阻塞依赖: 2个             │ │ │
│ │ │                                                                                                 │ │ │
│ │ │ 依赖状态分布:                                                                                   │ │ │
│ │ │ ✅ 已满足: 28个 (62%)  |  ⏳ 进行中: 12个 (27%)  |  ⚠️ 风险: 3个 (7%)  |  🚧 阻塞: 2个 (4%)   │ │ │
│ │ └─────────────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ 筛选条件                                                                                            │ │
│ │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│ │ │ Sprint: [全部▼]  |  团队: [全部▼]  |  依赖类型: [全部▼]  |  状态: [全部▼]  |  [搜索]  [重置]  │ │ │
│ │ └─────────────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ 依赖列表                                                                      [添加依赖] [批量导入]  │ │
│ │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│ │ │ 依赖ID │ 源MR/任务 │ 目标MR/任务 │ 依赖类型 │ 团队 │ 状态 │ 风险 │ 负责人 │ 操作 │             │ │ │
│ │ ├─────────────────────────────────────────────────────────────────────────────────────────────────┤ │ │
│ │ │ DEP-001│ MR-001   │ MR-002     │ FS      │ 同团队│ ✅已满足│ 低  │ 王芳  │ [详情][编辑][删除]│ │ │
│ │ │        │ 车道保持 │ 自适应巡航 │         │ ADAS │        │     │       │                   │ │ │
│ │ ├─────────────────────────────────────────────────────────────────────────────────────────────────┤ │ │
│ │ │ DEP-002│ MR-003   │ MR-005     │ FS      │ 跨团队│ ⏳进行中│ 中  │ 刘强  │ [详情][编辑][删除]│ │ │
│ │ │        │ 障碍物检测│ 路径规划  │         │ ADAS→│        │     │       │                   │ │ │
│ │ │        │          │            │         │ 规划 │        │     │       │                   │ │ │
│ │ ├─────────────────────────────────────────────────────────────────────────────────────────────────┤ │ │
│ │ │ DEP-003│ MR-007   │ MR-002     │ FS      │ 跨团队│ 🚧阻塞  │ 高  │ 赵磊  │ [详情][编辑][删除]│ │ │
│ │ │        │ 传感器融合│ 自适应巡航│         │ 感知→│        │     │       │                   │ │ │
│ │ │        │          │            │         │ ADAS │        │     │       │                   │ │ │
│ │ │        │ 🚧 阻塞原因: 传感器融合开发延期，预计延期3天                                          │ │ │
│ │ ├─────────────────────────────────────────────────────────────────────────────────────────────────┤ │ │
│ │ │ DEP-004│ T-05     │ T-06       │ FS      │ 同团队│ ⏳进行中│ 低  │ 刘强  │ [详情][编辑][删除]│ │ │
│ │ │        │ ACC开发  │ ACC测试    │         │ ADAS │        │     │       │                   │ │ │
│ │ ├─────────────────────────────────────────────────────────────────────────────────────────────────┤ │ │
│ │ │ DEP-005│ MR-010   │ MR-011     │ SS      │ 跨团队│ ⚠️风险  │ 高  │ 陈静  │ [详情][编辑][删除]│ │ │
│ │ │        │ 地图服务 │ 路径规划  │         │ 地图→│        │     │       │                   │ │ │
│ │ │        │          │            │         │ 规划 │        │     │       │                   │ │ │
│ │ │        │ ⚠️ 风险: 地图服务进度落后，可能影响路径规划                                           │ │ │
│ │ ├─────────────────────────────────────────────────────────────────────────────────────────────────┤ │ │
│ │ │ ...    │ ...      │ ...        │ ...     │ ...  │ ...    │ ... │ ...   │ ...               │ │ │
│ │ └─────────────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│ │                                                                                                     │ │
│ │ 共45条记录，当前第1页/共5页  [上一页] [1] [2] [3] [4] [5] [下一页]                                 │ │
│ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ 依赖关系图                                                                                   [返回列表]  │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ 视图选项                                                                                            │ │
│ │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│ │ │ 布局: [层次布局▼]  |  显示: [☑MR ☑任务]  |  筛选: [☑同团队 ☑跨团队]  |  [导出图片] [全屏]    │ │ │
│ │ └─────────────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ 依赖图                                                                                              │ │
│ │                                                                                                     │ │
│ │                    ┌──────────────┐                                                                 │ │
│ │                    │  MR-001      │                                                                 │ │
│ │                    │  车道保持    │                                                                 │ │
│ │                    │  ✅ 已完成   │                                                                 │ │
│ │                    └──────┬───────┘                                                                 │ │
│ │                           │ FS                                                                      │ │
│ │                           ↓                                                                         │ │
│ │                    ┌──────────────┐         ┌──────────────┐                                       │ │
│ │                    │  MR-002      │ ←─FS─── │  MR-007      │                                       │ │
│ │                    │  自适应巡航  │         │  传感器融合  │                                       │ │
│ │                    │  ⏳ 进行中   │         │  🚧 阻塞     │                                       │ │
│ │                    └──────┬───────┘         └──────────────┘                                       │ │
│ │                           │ FS                    ↑                                                 │ │
│ │                           ↓                       │ FS                                              │ │
│ │                    ┌──────────────┐         ┌──────────────┐                                       │ │
│ │                    │  MR-005      │ ←─FS─── │  MR-003      │                                       │ │
│ │                    │  路径规划    │         │  障碍物检测  │                                       │ │
│ │                    │  ⏳ 进行中   │         │  ⏳ 进行中   │                                       │ │
│ │                    └──────┬───────┘         └──────────────┘                                       │ │
│ │                           │ FS                                                                      │ │
│ │                           ↓                                                                         │ │
│ │                    ┌──────────────┐                                                                 │ │
│ │                    │  MR-011      │                                                                 │ │
│ │                    │  路径规划    │                                                                 │ │
│ │                    │  ⚠️ 风险     │                                                                 │ │
│ │                    └──────────────┘                                                                 │ │
│ │                           ↑                                                                         │ │
│ │                           │ SS                                                                      │ │
│ │                    ┌──────────────┐                                                                 │ │
│ │                    │  MR-010      │                                                                 │ │
│ │                    │  地图服务    │                                                                 │ │
│ │                    │  ⚠️ 风险     │                                                                 │ │
│ │                    └──────────────┘                                                                 │ │
│ │                                                                                                     │ │
│ │ 图例:                                                                                               │ │
│ │ ✅ 已满足  ⏳ 进行中  ⚠️ 风险  🚧 阻塞                                                              │ │
│ │ FS: Finish-to-Start  SS: Start-to-Start  FF: Finish-to-Finish  SF: Start-to-Finish                │ │
│ │                                                                                                     │ │
│ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ 关键路径分析                                                                                        │ │
│ │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│ │ │ 关键路径: MR-001 → MR-002 → MR-005 → MR-011                                                     │ │ │
│ │ │ 总工期: 28天  |  关键路径工期: 28天  |  浮动时间: 0天                                          │ │ │
│ │ │ ⚠️ 风险: MR-007阻塞可能导致MR-002延期，进而影响整个关键路径                                    │ │ │
│ │ └─────────────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 依赖矩阵

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ 依赖矩阵                                                                                     [返回列表]  │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ 依赖矩阵 (行依赖列)                                                                                 │ │
│ │                                                                                                     │ │
│ │         │ MR-001 │ MR-002 │ MR-003 │ MR-005 │ MR-007 │ MR-010 │ MR-011 │                           │ │
│ │ ────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤                           │ │
│ │ MR-001  │   -    │   ✅   │        │        │        │        │        │                           │ │
│ │ MR-002  │        │   -    │        │   ✅   │   🚧   │        │        │                           │ │
│ │ MR-003  │        │        │   -    │   ⏳   │        │        │        │                           │ │
│ │ MR-005  │        │        │        │   -    │        │        │   ⏳   │                           │ │
│ │ MR-007  │        │   🚧   │        │        │   -    │        │        │                           │ │
│ │ MR-010  │        │        │        │        │        │   -    │   ⚠️   │                           │ │
│ │ MR-011  │        │        │        │        │        │        │   -    │                           │ │
│ │                                                                                                     │ │
│ │ 图例: ✅ 已满足  ⏳ 进行中  ⚠️ 风险  🚧 阻塞                                                        │ │
│ │                                                                                                     │ │
│ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ 统计分析                                                                                            │ │
│ │ ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│ │ │ 依赖最多的MR: MR-002 (被3个MR依赖)                                                              │ │ │
│ │ │ 被依赖最多的MR: MR-011 (依赖2个MR)                                                              │ │ │
│ │ │ 循环依赖: 无                                                                                    │ │ │
│ │ └─────────────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.4 添加依赖弹窗

```
┌─────────────────────────────────────────────────────────────┐
│ 添加依赖                                              [×]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 基本信息                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 源MR/任务: [选择MR/任务▼]                               │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ MR-002: 自适应巡航控制开发                          │ │ │
│ │ │ 团队: ADAS团队                                      │ │ │
│ │ │ 负责人: 刘强                                        │ │ │
│ │ │ 状态: 进行中                                        │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ │                                                         │ │
│ │ 目标MR/任务: [选择MR/任务▼]                             │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ MR-007: 传感器融合                                  │ │ │
│ │ │ 团队: 感知团队                                      │ │ │
│ │ │ 负责人: 赵磊                                        │ │ │
│ │ │ 状态: 进行中                                        │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ │                                                         │ │
│ │ 依赖类型: ● FS  ○ SS  ○ FF  ○ SF                       │ │
│ │                                                         │ │
│ │ 依赖描述:                                               │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ 自适应巡航控制需要传感器融合提供的前车距离数据      │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 依赖协调                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 协调负责人: [选择人员▼] 刘强                            │ │
│ │                                                         │ │
│ │ 预计交付日期: [2025-02-10]                              │ │
│ │                                                         │ │
│ │ 风险等级: ○ 低  ● 中  ○ 高                             │ │
│ │                                                         │ │
│ │ 备注:                                                   │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ 需要与感知团队协调，确保传感器融合按时交付          │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ⚠️ 检测结果                                                 │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ✅ 无循环依赖                                           │ │
│ │ ⚠️ 跨团队依赖，建议在PI规划会议上确认                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ [取消]  [保存]                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.5 依赖详情弹窗

```
┌─────────────────────────────────────────────────────────────┐
│ 依赖详情: DEP-003                                     [×]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 基本信息                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 依赖ID: DEP-003                                         │ │
│ │ 依赖类型: FS (Finish-to-Start)                          │ │
│ │ 创建时间: 2025-01-20                                    │ │
│ │ 创建人: 刘强                                            │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 源MR                                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ MR-007: 传感器融合                                      │ │
│ │ 团队: 感知团队                                          │ │
│ │ 负责人: 赵磊                                            │ │
│ │ 状态: 🚧 阻塞                                           │ │
│ │ 进度: 60%                                               │ │
│ │ 预计完成: 2025-02-13 (延期3天)                          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 目标MR                                                      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ MR-002: 自适应巡航控制开发                              │ │
│ │ 团队: ADAS团队                                          │ │
│ │ 负责人: 刘强                                            │ │
│ │ 状态: ⏳ 进行中                                         │ │
│ │ 进度: 50%                                               │ │
│ │ 计划开始: 2025-02-10                                    │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 依赖状态                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 当前状态: 🚧 阻塞                                       │ │
│ │ 风险等级: 🔴 高                                         │ │
│ │ 阻塞原因: 传感器融合开发延期                            │ │
│ │ 影响分析: 可能导致自适应巡航控制延期3天                 │ │
│ │ 协调负责人: 刘强                                        │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 协调记录                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 2025-02-05 14:00 - 刘强                                 │ │
│ │ 与感知团队沟通，确认延期原因为硬件设备到货延迟          │ │
│ │ 预计2025-02-13完成                                      │ │
│ │                                                         │ │
│ │ 2025-02-03 10:00 - 刘强                                 │ │
│ │ 发现传感器融合进度落后，标记为阻塞                      │ │
│ │                                                         │ │
│ │ [添加协调记录]                                          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 行动项                                                      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 🔴 协调硬件设备到货 - 负责人: PM - 截止: 2025-02-06     │ │
│ │ 🟡 评估延期影响 - 负责人: 刘强 - 截止: 2025-02-06       │ │
│ │ [添加行动项]                                            │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ [关闭]  [更新状态]  [添加评论]  [导出]                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、交互流程

### 3.1 添加依赖流程

```
点击"添加依赖"
  ↓
选择源MR/任务
  ↓
选择目标MR/任务
  ↓
选择依赖类型
  ├─ FS: Finish-to-Start
  ├─ SS: Start-to-Start
  ├─ FF: Finish-to-Finish
  └─ SF: Start-to-Finish
  ↓
填写依赖描述
  ↓
设置协调信息
  ├─ 协调负责人
  ├─ 预计交付日期
  ├─ 风险等级
  └─ 备注
  ↓
系统检查
  ├─ 循环依赖检查
  │   ├─ 无循环 → 允许添加
  │   └─ 有循环 → 提示错误
  ├─ 跨团队依赖检查
  │   └─ 跨团队 → 提示需要协调
  └─ 依赖合理性检查
      └─ 合理 → 允许添加
  ↓
保存依赖
  ├─ 创建依赖记录
  ├─ 发送通知
  └─ 更新依赖图
  ↓
完成
```



### 3.2 依赖跟踪流程

```
定期检查依赖状态
  ↓
识别风险依赖
  ├─ 源MR/任务延期
  ├─ 目标MR/任务提前
  └─ 跨团队协调问题
  ↓
更新依赖状态
  ├─ 已满足
  ├─ 进行中
  ├─ 风险
  └─ 阻塞
  ↓
风险依赖处理
  ├─ 标记风险等级
  ├─ 记录风险原因
  ├─ 指定协调负责人
  └─ 制定应对措施
  ↓
发送通知
  ├─ 通知源MR负责人
  ├─ 通知目标MR负责人
  └─ 通知协调负责人
  ↓
跟踪解决进度
  ↓
完成
```

### 3.3 循环依赖检测流程

```
添加/修改依赖
  ↓
构建依赖图
  ↓
深度优先搜索
  ├─ 检测环路
  │   ├─ 无环 → 允许操作
  │   └─ 有环 → 提示循环依赖
  └─ 标记访问节点
  ↓
返回检测结果
  ├─ 无循环依赖 → 保存
  └─ 有循环依赖 → 拒绝并提示
  ↓
完成
```

---

## 四、字段说明

### 4.1 依赖关系字段

| 字段名 | 类型 | 说明 | 示例 |
|-------|------|------|------|
| dependency_id | UUID | 依赖ID | dep-001 |
| source_type | Enum | 源类型 | MR, TASK |
| source_id | UUID | 源ID | mr-001 |
| target_type | Enum | 目标类型 | MR, TASK |
| target_id | UUID | 目标ID | mr-002 |
| dependency_type | Enum | 依赖类型 | FS, SS, FF, SF |
| description | Text | 依赖描述 | - |
| status | Enum | 依赖状态 | SATISFIED, IN_PROGRESS, AT_RISK, BLOCKED |
| risk_level | Enum | 风险等级 | LOW, MEDIUM, HIGH |
| coordinator_id | UUID | 协调负责人 | user-001 |
| expected_delivery_date | Date | 预计交付日期 | 2025-02-10 |
| is_cross_team | Boolean | 是否跨团队 | true |
| notes | Text | 备注 | - |

### 4.2 依赖状态枚举

| 状态值 | 说明 | 图标 |
|-------|------|------|
| SATISFIED | 已满足 | ✅ |
| IN_PROGRESS | 进行中 | ⏳ |
| AT_RISK | 风险 | ⚠️ |
| BLOCKED | 阻塞 | 🚧 |

### 4.3 依赖类型枚举

| 类型值 | 说明 | 示例 |
|-------|------|------|
| FS | Finish-to-Start | A完成后B才能开始 |
| SS | Start-to-Start | A开始后B才能开始 |
| FF | Finish-to-Finish | A完成后B才能完成 |
| SF | Start-to-Finish | A开始后B才能完成 |

---

## 五、业务规则

### 5.1 循环依赖检测规则
- **检测时机**: 添加/修改依赖时
- **检测算法**: 深度优先搜索（DFS）
- **处理方式**: 拒绝添加并提示循环依赖
- **示例**: A依赖B，B依赖C，C依赖A → 循环依赖

### 5.2 跨团队依赖规则
- **识别**: 源和目标属于不同团队
- **协调**: 需要指定协调负责人
- **沟通**: 建议在PI规划会议上确认
- **跟踪**: 定期检查跨团队依赖状态

### 5.3 依赖状态更新规则
- **自动更新**:
  - 源MR/任务完成 → 依赖状态更新为"已满足"
  - 源MR/任务延期 → 依赖状态更新为"风险"或"阻塞"
- **手动更新**: 协调负责人可手动更新依赖状态
- **通知机制**: 状态变更时通知相关人员

### 5.4 关键路径分析规则
- **关键路径**: 工期最长的路径
- **浮动时间**: 非关键路径的时间余量
- **风险识别**: 关键路径上的风险依赖优先处理

### 5.5 依赖风险评估规则
- **低风险**:
  - 团队内依赖
  - 源MR/任务进度正常
  - 无历史延期记录
- **中风险**:
  - 跨团队依赖
  - 源MR/任务进度略有延迟
  - 有少量历史延期记录
- **高风险**:
  - 跨PI依赖
  - 源MR/任务严重延期
  - 有多次历史延期记录

---

## 六、API接口设计

### 6.1 获取依赖列表

**接口**: `GET /api/v1/dependencies`

**查询参数**:
```
sprint_id: Sprint ID (可选)
team_id: 团队ID (可选)
dependency_type: 依赖类型 (可选)
status: 依赖状态 (可选)
is_cross_team: 是否跨团队 (可选)
page: 页码
page_size: 每页数量
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "total": 45,
    "page": 1,
    "page_size": 10,
    "statistics": {
      "total": 45,
      "internal": 32,
      "cross_team": 13,
      "at_risk": 5,
      "blocked": 2,
      "status_distribution": {
        "satisfied": 28,
        "in_progress": 12,
        "at_risk": 3,
        "blocked": 2
      }
    },
    "dependencies": [
      {
        "dependency_id": "dep-001",
        "source": {
          "type": "MR",
          "id": "mr-001",
          "number": "MR-001",
          "name": "车道保持算法开发",
          "team": "ADAS团队",
          "assignee": "王芳",
          "status": "DONE"
        },
        "target": {
          "type": "MR",
          "id": "mr-002",
          "number": "MR-002",
          "name": "自适应巡航控制开发",
          "team": "ADAS团队",
          "assignee": "刘强",
          "status": "IN_PROGRESS"
        },
        "dependency_type": "FS",
        "status": "SATISFIED",
        "risk_level": "LOW",
        "is_cross_team": false,
        "coordinator": {
          "user_id": "user-003",
          "name": "王芳"
        },
        "created_at": "2025-01-20T10:00:00Z"
      }
    ]
  }
}
```

### 6.2 添加依赖

**接口**: `POST /api/v1/dependencies`

**请求体**:
```json
{
  "source_type": "MR",
  "source_id": "mr-002",
  "target_type": "MR",
  "target_id": "mr-007",
  "dependency_type": "FS",
  "description": "自适应巡航控制需要传感器融合提供的前车距离数据",
  "coordinator_id": "user-004",
  "expected_delivery_date": "2025-02-10",
  "risk_level": "MEDIUM",
  "notes": "需要与感知团队协调，确保传感器融合按时交付"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "依赖添加成功",
  "data": {
    "dependency_id": "dep-003",
    "validation": {
      "has_cycle": false,
      "is_cross_team": true,
      "warnings": [
        "跨团队依赖，建议在PI规划会议上确认"
      ]
    },
    "created_at": "2025-02-05T10:00:00Z"
  }
}
```

### 6.3 获取依赖图数据

**接口**: `GET /api/v1/dependencies/graph`

**查询参数**:
```
sprint_id: Sprint ID (可选)
include_tasks: 是否包含任务级别依赖 (可选)
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "nodes": [
      {
        "id": "mr-001",
        "type": "MR",
        "number": "MR-001",
        "name": "车道保持算法开发",
        "status": "DONE",
        "team": "ADAS团队"
      },
      {
        "id": "mr-002",
        "type": "MR",
        "number": "MR-002",
        "name": "自适应巡航控制开发",
        "status": "IN_PROGRESS",
        "team": "ADAS团队"
      }
    ],
    "edges": [
      {
        "source": "mr-001",
        "target": "mr-002",
        "dependency_type": "FS",
        "status": "SATISFIED",
        "risk_level": "LOW"
      }
    ],
    "critical_path": {
      "path": ["mr-001", "mr-002", "mr-005", "mr-011"],
      "total_duration": 28,
      "critical_duration": 28,
      "float_time": 0
    }
  }
}
```

### 6.4 更新依赖状态

**接口**: `PUT /api/v1/dependencies/{dependency_id}/status`

**请求体**:
```json
{
  "status": "AT_RISK",
  "risk_level": "HIGH",
  "notes": "传感器融合开发延期，可能影响自适应巡航控制",
  "action_items": [
    {
      "description": "协调硬件设备到货",
      "assignee_id": "user-001",
      "due_date": "2025-02-06"
    }
  ]
}
```

**响应**:
```json
{
  "code": 200,
  "message": "依赖状态更新成功",
  "data": {
    "dependency_id": "dep-003",
    "status": "AT_RISK",
    "updated_at": "2025-02-05T14:00:00Z",
    "notifications_sent": [
      "user-004",
      "user-007"
    ]
  }
}
```

### 6.5 删除依赖

**接口**: `DELETE /api/v1/dependencies/{dependency_id}`

**响应**:
```json
{
  "code": 200,
  "message": "依赖删除成功"
}
```

### 6.6 获取依赖详情

**接口**: `GET /api/v1/dependencies/{dependency_id}`

**响应**:
```json
{
  "code": 200,
  "data": {
    "dependency_id": "dep-003",
    "source": {
      "type": "MR",
      "id": "mr-007",
      "number": "MR-007",
      "name": "传感器融合",
      "team": "感知团队",
      "assignee": "赵磊",
      "status": "IN_PROGRESS",
      "progress": 60,
      "planned_end_date": "2025-02-10",
      "actual_end_date": "2025-02-13"
    },
    "target": {
      "type": "MR",
      "id": "mr-002",
      "number": "MR-002",
      "name": "自适应巡航控制开发",
      "team": "ADAS团队",
      "assignee": "刘强",
      "status": "IN_PROGRESS",
      "progress": 50,
      "planned_start_date": "2025-02-10"
    },
    "dependency_type": "FS",
    "description": "自适应巡航控制需要传感器融合提供的前车距离数据",
    "status": "BLOCKED",
    "risk_level": "HIGH",
    "is_cross_team": true,
    "coordinator": {
      "user_id": "user-004",
      "name": "刘强"
    },
    "expected_delivery_date": "2025-02-10",
    "notes": "需要与感知团队协调，确保传感器融合按时交付",
    "coordination_records": [
      {
        "record_id": "rec-001",
        "user": {
          "user_id": "user-004",
          "name": "刘强"
        },
        "content": "与感知团队沟通，确认延期原因为硬件设备到货延迟，预计2025-02-13完成",
        "created_at": "2025-02-05T14:00:00Z"
      },
      {
        "record_id": "rec-002",
        "user": {
          "user_id": "user-004",
          "name": "刘强"
        },
        "content": "发现传感器融合进度落后，标记为阻塞",
        "created_at": "2025-02-03T10:00:00Z"
      }
    ],
    "action_items": [
      {
        "action_id": "act-001",
        "description": "协调硬件设备到货",
        "assignee": {
          "user_id": "user-001",
          "name": "PM"
        },
        "status": "IN_PROGRESS",
        "due_date": "2025-02-06"
      },
      {
        "action_id": "act-002",
        "description": "评估延期影响",
        "assignee": {
          "user_id": "user-004",
          "name": "刘强"
        },
        "status": "TODO",
        "due_date": "2025-02-06"
      }
    ],
    "created_at": "2025-01-20T10:00:00Z",
    "updated_at": "2025-02-05T14:00:00Z"
  }
}
```

### 6.7 获取依赖矩阵

**接口**: `GET /api/v1/dependencies/matrix`

**查询参数**:
```
sprint_id: Sprint ID (可选)
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "items": [
      "mr-001",
      "mr-002",
      "mr-003",
      "mr-005",
      "mr-007",
      "mr-010",
      "mr-011"
    ],
    "matrix": {
      "mr-001": {
        "mr-002": "SATISFIED"
      },
      "mr-002": {
        "mr-005": "SATISFIED",
        "mr-007": "BLOCKED"
      },
      "mr-003": {
        "mr-005": "IN_PROGRESS"
      },
      "mr-005": {
        "mr-011": "IN_PROGRESS"
      },
      "mr-010": {
        "mr-011": "AT_RISK"
      }
    },
    "statistics": {
      "most_depended": {
        "id": "mr-002",
        "count": 3
      },
      "most_depending": {
        "id": "mr-011",
        "count": 2
      },
      "has_cycle": false
    }
  }
}
```

---

## 七、Mock数据

### 7.1 依赖列表Mock数据

```javascript
const mockDependencies = [
  {
    dependency_id: 'dep-001',
    source: {
      type: 'MR',
      id: 'mr-001',
      number: 'MR-001',
      name: '车道保持算法开发',
      team: 'ADAS团队',
      assignee: '王芳',
      status: 'DONE'
    },
    target: {
      type: 'MR',
      id: 'mr-002',
      number: 'MR-002',
      name: '自适应巡航控制开发',
      team: 'ADAS团队',
      assignee: '刘强',
      status: 'IN_PROGRESS'
    },
    dependency_type: 'FS',
    status: 'SATISFIED',
    risk_level: 'LOW',
    is_cross_team: false,
    coordinator: {
      user_id: 'user-003',
      name: '王芳'
    },
    created_at: '2025-01-20T10:00:00Z'
  },
  {
    dependency_id: 'dep-002',
    source: {
      type: 'MR',
      id: 'mr-002',
      number: 'MR-002',
      name: '自适应巡航控制开发',
      team: 'ADAS团队',
      assignee: '刘强',
      status: 'IN_PROGRESS'
    },
    target: {
      type: 'MR',
      id: 'mr-005',
      number: 'MR-005',
      name: '路径规划',
      team: '规划团队',
      assignee: '陈静',
      status: 'IN_PROGRESS'
    },
    dependency_type: 'FS',
    status: 'SATISFIED',
    risk_level: 'LOW',
    is_cross_team: true,
    coordinator: {
      user_id: 'user-004',
      name: '刘强'
    },
    created_at: '2025-01-21T10:00:00Z'
  },
  {
    dependency_id: 'dep-003',
    source: {
      type: 'MR',
      id: 'mr-007',
      number: 'MR-007',
      name: '传感器融合',
      team: '感知团队',
      assignee: '赵磊',
      status: 'IN_PROGRESS'
    },
    target: {
      type: 'MR',
      id: 'mr-002',
      number: 'MR-002',
      name: '自适应巡航控制开发',
      team: 'ADAS团队',
      assignee: '刘强',
      status: 'IN_PROGRESS'
    },
    dependency_type: 'FS',
    status: 'BLOCKED',
    risk_level: 'HIGH',
    is_cross_team: true,
    coordinator: {
      user_id: 'user-004',
      name: '刘强'
    },
    created_at: '2025-01-22T10:00:00Z'
  }
];
```

### 7.2 依赖图Mock数据

```javascript
const mockDependencyGraph = {
  nodes: [
    {
      id: 'mr-001',
      type: 'MR',
      number: 'MR-001',
      name: '车道保持算法开发',
      status: 'DONE',
      team: 'ADAS团队'
    },
    {
      id: 'mr-002',
      type: 'MR',
      number: 'MR-002',
      name: '自适应巡航控制开发',
      status: 'IN_PROGRESS',
      team: 'ADAS团队'
    },
    {
      id: 'mr-003',
      type: 'MR',
      number: 'MR-003',
      name: '障碍物检测',
      status: 'IN_PROGRESS',
      team: '感知团队'
    },
    {
      id: 'mr-005',
      type: 'MR',
      number: 'MR-005',
      name: '路径规划',
      status: 'IN_PROGRESS',
      team: '规划团队'
    },
    {
      id: 'mr-007',
      type: 'MR',
      number: 'MR-007',
      name: '传感器融合',
      status: 'IN_PROGRESS',
      team: '感知团队'
    },
    {
      id: 'mr-010',
      type: 'MR',
      number: 'MR-010',
      name: '地图服务',
      status: 'AT_RISK',
      team: '地图团队'
    },
    {
      id: 'mr-011',
      type: 'MR',
      number: 'MR-011',
      name: '路径规划',
      status: 'AT_RISK',
      team: '规划团队'
    }
  ],
  edges: [
    {
      source: 'mr-001',
      target: 'mr-002',
      dependency_type: 'FS',
      status: 'SATISFIED',
      risk_level: 'LOW'
    },
    {
      source: 'mr-002',
      target: 'mr-005',
      dependency_type: 'FS',
      status: 'SATISFIED',
      risk_level: 'LOW'
    },
    {
      source: 'mr-007',
      target: 'mr-002',
      dependency_type: 'FS',
      status: 'BLOCKED',
      risk_level: 'HIGH'
    },
    {
      source: 'mr-003',
      target: 'mr-005',
      dependency_type: 'FS',
      status: 'IN_PROGRESS',
      risk_level: 'MEDIUM'
    },
    {
      source: 'mr-005',
      target: 'mr-011',
      dependency_type: 'FS',
      status: 'IN_PROGRESS',
      risk_level: 'MEDIUM'
    },
    {
      source: 'mr-010',
      target: 'mr-011',
      dependency_type: 'SS',
      status: 'AT_RISK',
      risk_level: 'HIGH'
    }
  ],
  critical_path: {
    path: ['mr-001', 'mr-002', 'mr-005', 'mr-011'],
    total_duration: 28,
    critical_duration: 28,
    float_time: 0
  }
};
```

---

## 八、前端实现建议

### 8.1 依赖图可视化

**推荐库**:
- **D3.js**: 强大的数据可视化库，适合复杂的依赖图
- **Cytoscape.js**: 专门用于图形可视化的库
- **React Flow**: React生态下的流程图库

**实现要点**:
```javascript
// 使用React Flow示例
import ReactFlow, {
  MiniMap,
  Controls,
  Background
} from 'reactflow';

const DependencyGraph = ({ nodes, edges }) => {
  const nodeTypes = {
    mr: MRNode,
    task: TaskNode
  };

  const edgeTypes = {
    dependency: DependencyEdge
  };

  return (
    <ReactFlow
      nodes={nodes}
      edges={edges}
      nodeTypes={nodeTypes}
      edgeTypes={edgeTypes}
      fitView
    >
      <MiniMap />
      <Controls />
      <Background />
    </ReactFlow>
  );
};
```

### 8.2 循环依赖检测

```javascript
// 深度优先搜索检测循环依赖
function detectCycle(graph, sourceId, targetId) {
  const visited = new Set();
  const recStack = new Set();

  function dfs(nodeId) {
    if (recStack.has(nodeId)) {
      return true; // 发现循环
    }
    if (visited.has(nodeId)) {
      return false;
    }

    visited.add(nodeId);
    recStack.add(nodeId);

    const neighbors = graph[nodeId] || [];
    for (const neighbor of neighbors) {
      if (dfs(neighbor)) {
        return true;
      }
    }

    recStack.delete(nodeId);
    return false;
  }

  // 临时添加新边
  const tempGraph = { ...graph };
  if (!tempGraph[sourceId]) {
    tempGraph[sourceId] = [];
  }
  tempGraph[sourceId].push(targetId);

  return dfs(sourceId);
}
```

### 8.3 关键路径计算

```javascript
// 计算关键路径
function calculateCriticalPath(nodes, edges) {
  // 1. 构建邻接表
  const graph = buildGraph(nodes, edges);

  // 2. 拓扑排序
  const sorted = topologicalSort(graph);

  // 3. 计算最早开始时间
  const earliestStart = calculateEarliestStart(sorted, graph);

  // 4. 计算最晚开始时间
  const latestStart = calculateLatestStart(sorted, graph);

  // 5. 计算浮动时间
  const floatTime = calculateFloatTime(earliestStart, latestStart);

  // 6. 识别关键路径（浮动时间为0的路径）
  const criticalPath = findCriticalPath(floatTime);

  return {
    path: criticalPath,
    total_duration: calculateTotalDuration(nodes),
    critical_duration: calculateCriticalDuration(criticalPath, nodes),
    float_time: Math.min(...Object.values(floatTime))
  };
}
```

---

## 九、注意事项

### 9.1 性能优化
- **依赖图渲染**: 对于大型依赖图（>100个节点），使用虚拟化或分层渲染
- **循环依赖检测**: 使用缓存避免重复计算
- **关键路径计算**: 仅在依赖关系变更时重新计算

### 9.2 用户体验
- **可视化**: 使用不同颜色和图标区分依赖状态
- **交互**: 支持拖拽、缩放、搜索等操作
- **提示**: 在添加依赖时提供实时反馈（循环依赖、跨团队等）

### 9.3 数据一致性
- **状态同步**: 依赖状态应与MR/任务状态保持同步
- **通知机制**: 依赖状态变更时及时通知相关人员
- **历史记录**: 保留依赖变更历史，便于追溯

### 9.4 权限控制
- **添加依赖**: 仅MR/任务负责人或团队成员可添加
- **更新状态**: 仅协调负责人或相关人员可更新
- **删除依赖**: 仅创建人或管理员可删除

---

## 十、扩展功能

### 10.1 依赖预测
- 基于历史数据预测依赖风险
- 提前识别可能的延期依赖
- 建议优化依赖关系

### 10.2 依赖报告
- 生成依赖分析报告
- 导出依赖图为图片或PDF
- 定期发送依赖状态摘要

### 10.3 依赖模板
- 保存常用依赖模式
- 快速应用依赖模板
- 团队共享依赖模板

### 10.4 依赖影响分析
- 分析依赖变更的影响范围
- 计算延期的连锁反应
- 提供优化建议

