# C6-F05: 回滚管理

> **功能编号**: C6-F05  
> **功能名称**: 回滚管理  
> **所属模块**: C6-发布管理 > 发布执行  
> **主要用户**: OPS  
> **页面类型**: 列表页 + 执行页

---

## 一、功能概述

### 1.1 功能定位
回滚管理支持快速回滚到上一个稳定版本，降低发布风险。

### 1.2 核心价值
- **快速回滚**: 一键回滚到稳定版本
- **自动回滚**: 异常自动触发回滚
- **版本管理**: 管理可回滚版本
- **回滚验证**: 回滚后自动验证

---

## 二、页面设计

### 2.1 回滚列表

```
┌─────────────────────────────────────────────────────────────┐
│ ⏪ 回滚管理                          [筛选] [刷新] [导出]  │
├─────────────────────────────────────────────────────────────┤
│  筛选: [全部环境 ▼] [最近30天 ▼]                          │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ 时间         │ 环境   │ 从版本 │ 到版本 │ 原因  │状态│ │
│  ├──────────────┼────────┼────────┼────────┼───────┼────┤ │
│  │ 2025-01-18   │ 生产   │ V2.0.4 │ V2.0.3 │ 性能  │成功│ │
│  │ 10:30        │        │        │        │ 问题  │    │ │
│  ├──────────────┼────────┼────────┼────────┼───────┼────┤ │
│  │ 2025-01-10   │ 预生产 │ V2.0.3 │ V2.0.2 │ 功能  │成功│ │
│  │ 15:00        │        │        │        │ 缺陷  │    │ │
│  ├──────────────┼────────┼────────┼────────┼───────┼────┤ │
│  │ 2024-12-20   │ 生产   │ V2.0.1 │ V2.0.0 │ 严重  │成功│ │
│  │ 09:00        │        │        │        │ Bug   │    │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 回滚执行

```
┌─────────────────────────────────────────────────────────────┐
│ ⏪ 回滚执行 - 生产环境                  [取消] [确认]      │
├─────────────────────────────────────────────────────────────┤
│  回滚信息                                                   │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ 当前版本: V2.1.0                                       │ │
│  │ 目标版本: V2.0.0                                       │ │
│  │ 环境: 生产环境                                         │ │
│  │ 回滚方式: 蓝绿切换                                     │ │
│  │ 预计耗时: 5分钟                                        │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                             │
│  回滚原因                                                   │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ ● 性能问题                                             │ │
│  │ ○ 功能缺陷                                             │ │
│  │ ○ 严重Bug                                              │ │
│  │ ○ 其他: [                                    ]        │ │
│  │                                                        │ │
│  │ 详细说明:                                              │ │
│  │ ┌──────────────────────────────────────────────────┐  │ │
│  │ │ 三路摄像头帧率低于30fps，影响用户体验            │  │ │
│  │ │                                                  │  │ │
│  │ └──────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                             │
│  回滚前检查                                                 │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ ✅ 目标版本可用                                        │ │
│  │ ✅ 数据库兼容                                          │ │
│  │ ✅ 配置文件兼容                                        │ │
│  │ ✅ 依赖服务正常                                        │ │
│  │ ✅ 备份已完成                                          │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                             │
│  影响评估                                                   │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ ⚠️ 回滚影响:                                          │ │
│  │ • 将丢失V2.1.0的新功能                                │ │
│  │ • 需要重新部署V2.1.0修复后的版本                      │ │
│  │ • 预计影响用户: 0 (蓝绿切换，无影响)                  │ │
│  │                                                        │ │
│  │ 💡 建议:                                              │ │
│  │ • 回滚后立即修复性能问题                              │ │
│  │ • 在测试环境充分验证后再次发布                        │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                             │
│  [确认回滚] [取消]                                         │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 回滚进度

```
┌─────────────────────────────────────────────────────────────┐
│ ⏪ 回滚进度 - 生产环境                                      │
├─────────────────────────────────────────────────────────────┤
│  回滚信息                                                   │
│  从版本: V2.1.0 → 目标版本: V2.0.0                         │
│  开始时间: 2025-02-15 10:35 | 已耗时: 2分钟                │
│                                                             │
│  回滚进度                                                   │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ ████████████░░░░░░░░  60%                             │ │
│  │                                                        │ │
│  │ ✅ 回滚前检查 (10:35-10:36)                           │ │
│  │ ✅ 停止新版本流量 (10:36-10:37)                       │ │
│  │ 🔵 切换到旧版本 (10:37-进行中)                        │ │
│  │    当前流量: V2.0.0 80%                                │ │
│  │ ⚪ 健康检查                                            │ │
│  │ ⚪ 下线新版本                                          │ │
│  │ ⚪ 回滚验证                                            │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                             │
│  实时监控                                                   │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ V2.0.0 (旧版本)                                       │ │
│  │ • 流量: 80%                                            │ │
│  │ • 请求成功率: 99.9%                                    │ │
│  │ • 平均响应时间: 90ms                                   │ │
│  │                                                        │ │
│  │ V2.1.0 (新版本)                                       │ │
│  │ • 流量: 20%                                            │ │
│  │ • 请求成功率: 99.8%                                    │ │
│  │ • 平均响应时间: 85ms                                   │ │
│  │                                                        │ │
│  │ 告警: 无                                               │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                             │
│  回滚日志                                                   │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ [10:35:00] 开始回滚到V2.0.0                           │ │
│  │ [10:35:05] 回滚前检查通过                             │ │
│  │ [10:36:00] 开始停止新版本流量                         │ │
│  │ [10:37:00] 开始切换到旧版本                           │ │
│  │ [10:37:30] 流量切换至80%                              │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、数据设计

```typescript
interface Rollback {
  id: string;
  environment: string;
  fromVersion: string;
  toVersion: string;
  reason: 'PERFORMANCE' | 'BUG' | 'DEFECT' | 'OTHER';
  reasonDetail: string;
  startTime: Date;
  endTime?: Date;
  status: 'PENDING' | 'RUNNING' | 'COMPLETED' | 'FAILED';
  executor: string;
  prechecks: Array<{
    name: string;
    status: 'PASSED' | 'FAILED';
  }>;
  impact: {
    lostFeatures: string[];
    affectedUsers: number;
    recommendations: string[];
  };
  progress: {
    percentage: number;
    currentStep: string;
    steps: Array<{
      name: string;
      status: 'PENDING' | 'RUNNING' | 'COMPLETED' | 'FAILED';
      startTime?: Date;
      endTime?: Date;
    }>;
  };
  metrics: {
    oldVersion: { traffic: number; successRate: number; responseTime: number };
    newVersion: { traffic: number; successRate: number; responseTime: number };
  };
  logs: Array<{ time: Date; message: string }>;
}
```

---

## 四、Mock数据

```json
{
  "id": "RB-001",
  "environment": "生产环境",
  "fromVersion": "V2.1.0",
  "toVersion": "V2.0.0",
  "reason": "PERFORMANCE",
  "reasonDetail": "三路摄像头帧率低于30fps，影响用户体验",
  "startTime": "2025-02-15T10:35:00Z",
  "status": "RUNNING",
  "executor": "OPS-李四",
  "prechecks": [
    {"name": "目标版本可用", "status": "PASSED"},
    {"name": "数据库兼容", "status": "PASSED"},
    {"name": "配置文件兼容", "status": "PASSED"}
  ],
  "impact": {
    "lostFeatures": ["智能驾驶功能增强"],
    "affectedUsers": 0,
    "recommendations": ["回滚后立即修复性能问题", "在测试环境充分验证后再次发布"]
  },
  "progress": {
    "percentage": 60,
    "currentStep": "切换到旧版本",
    "steps": [
      {"name": "回滚前检查", "status": "COMPLETED"},
      {"name": "切换到旧版本", "status": "RUNNING"},
      {"name": "健康检查", "status": "PENDING"}
    ]
  },
  "metrics": {
    "oldVersion": {"traffic": 80, "successRate": 99.9, "responseTime": 90},
    "newVersion": {"traffic": 20, "successRate": 99.8, "responseTime": 85}
  },
  "logs": [
    {"time": "2025-02-15T10:35:00Z", "message": "开始回滚到V2.0.0"},
    {"time": "2025-02-15T10:37:30Z", "message": "流量切换至80%"}
  ]
}
```

---

**设计完成日期**: 2025-01-16

