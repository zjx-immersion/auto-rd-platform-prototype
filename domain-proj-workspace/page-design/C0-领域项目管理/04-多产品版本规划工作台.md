# C0-04: 多产品版本规划工作台

> **页面标识**: C0-04  
> **优先级**: P0 ⭐⭐⭐⭐⭐ （2级核心页面）  
> **设计版本**: V3.0  
> **更新时间**: 2026-01-20  
> **参考原型**: NIO NSDP TimePlan (截图3)

---

## 📋 页面概述

### 定位与价值

**页面定位**：2级计划的核心工作台，整车软件研发项目的多产品版本规划中心

**核心价值**：
1. ✅ **统一迭代轴**：项目级全局26个迭代时间轴
2. ✅ **多产品协同**：多个产品版本映射到同一迭代轴
3. ✅ **可视化规划**：甘特图展示版本与里程碑对齐关系
4. ✅ **拖拽交互**：直观的版本创建和调整
5. ✅ **集成关系**：版本、Epic、里程碑的全局视图

---

## 🎯 功能需求

### 核心功能列表

| 功能模块 | 功能点 | 优先级 |
|---------|-------|--------|
| **迭代轴展示** | 横向时间轴，显示26个迭代 | P0 |
| **里程碑标注** | 在迭代轴上标注EP/PP/SOP | P0 |
| **版本甘特图** | 产品版本条状图展示 | P0 |
| **产品分组** | 按产品线分组，支持折叠 | P0 |
| **版本创建** | 点击打开版本创建向导 | P0 |
| **版本编辑** | 选中版本显示详情和编辑 | P0 |
| **Epic查看** | 查看版本关联的Epic | P1 |
| **对齐状态** | 版本与里程碑对齐状态提示 | P1 |
| **PI生成** | 生成PI集合按钮 | P0 |
| **时间轴缩放** | 支持Timeline缩放和滚动 | P2 |

---

## 🖼️ 页面布局

### 整体布局结构

```
┌────────────────────────────────────────────────────────────────────────────┐
│ 🎨 顶部操作栏（固定）                                                        │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ ◀ 返回Timeline    多产品版本规划工作台 - 岚图H56项目                  │   │
│ │                                                                       │   │
│ │ [💾 保存规划] [🔄 刷新] [🎯 生成PI集合] [➡️ 进入PI Planning]          │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 📊 项目信息栏（可折叠）                                                      │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ 项目周期：2025-02-01 ~ 2026-01-31 (52周，26个迭代)                   │   │
│ │ 迭代配置：2周/迭代                                                    │   │
│ │ 里程碑：                                                              │   │
│ │   🏁 EP (工程样车) - 迭代12 - 2025-06-30                             │   │
│ │   🏁 PP (PP车) - 迭代18 - 2025-09-30                                 │   │
│ │   🏁 SOP (量产车) - 迭代26 - 2025-12-31                              │   │
│ │ 已规划版本：8个 | 总Story Points：1200 SP                            │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 🎨 工作台主区域（可滚动）                                                    │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │                                                                       │   │
│ │ 📐 迭代轴区（横向固定头部）                                           │   │
│ │ ┌────────────────────────────────────────────────────────────────┐  │   │
│ │ │ [迭1][迭2][迭3][迭4][迭5][迭6][迭7][迭8]...[迭26]             │  │   │
│ │ │   ↑                    ↑                    ↑                  │  │   │
│ │ │   EP(12)               PP(18)               SOP(26)            │  │   │
│ │ │                                                                 │  │   │
│ │ │ 🔍 缩放：[─────●─────] 📅 时间跨度：2月-12月               │  │   │
│ │ └────────────────────────────────────────────────────────────────┘  │   │
│ │                                                                       │   │
│ │ 📦 产品版本列表区（纵向滚动）                                         │   │
│ │ ┌────────────────────────────────────────────────────────────────┐  │   │
│ │ │                                                                 │  │   │
│ │ │ ▼ 🚗 产品A - ADAS ECU (Domain: 智能驾驶)                       │  │   │
│ │ │   ┌─────────────────────────────────────────────────────────┐ │  │   │
│ │ │   │ V1.0 ████████████████ (迭1-6) → EP 🟢 80%               │ │  │   │
│ │ │   │ 80 SP | 2 Epics | 开始:2025-02-01 | 结束:2025-04-25    │ │  │   │
│ │ │   │ [✏️ 编辑] [👁️ 查看Epic] [🗑️ 删除]                       │ │  │   │
│ │ │   └─────────────────────────────────────────────────────────┘ │  │   │
│ │ │   ┌─────────────────────────────────────────────────────────┐ │  │   │
│ │ │   │ V1.1              ████████████ (迭7-12) → PP 🟡 100%   │ │  │   │
│ │ │   │ 100 SP | 3 Epics | 开始:2025-04-26 | 结束:2025-07-18  │ │  │   │
│ │ │   │ [✏️ 编辑] [👁️ 查看Epic] [🗑️ 删除]                       │ │  │   │
│ │ │   └─────────────────────────────────────────────────────────┘ │  │   │
│ │ │   [+ 新增版本]                                               │  │   │
│ │ │                                                                 │  │   │
│ │ │ ▼ 📱 产品B - 座舱HMI (Domain: 智能座舱)                        │  │   │
│ │ │   ┌─────────────────────────────────────────────────────────┐ │  │   │
│ │ │   │ V1.0 ████████████████ (迭1-6) → EP 🟢 100%              │ │  │   │
│ │ │   │ 80 SP | 1 Epic                                          │ │  │   │
│ │ │   │ [✏️ 编辑] [👁️ 查看Epic] [🗑️ 删除]                       │ │  │   │
│ │ │   └─────────────────────────────────────────────────────────┘ │  │   │
│ │ │   [+ 新增版本]                                               │  │   │
│ │ │                                                                 │  │   │
│ │ │ ▼ 🔌 产品C - 网关 (Domain: EEA)                                │  │   │
│ │ │   ┌─────────────────────────────────────────────────────────┐ │  │   │
│ │ │   │ V1.0    ████████████████ (迭3-8) → EP 🟢 100%          │ │  │   │
│ │ │   │ 80 SP | 2 Epics                                         │ │  │   │
│ │ │   │ [✏️ 编辑] [👁️ 查看Epic] [🗑️ 删除]                       │ │  │   │
│ │ │   └─────────────────────────────────────────────────────────┘ │  │   │
│ │ │   [+ 新增版本]                                               │  │   │
│ │ │                                                                 │  │   │
│ │ │ [+ 添加新产品版本]                                             │  │   │
│ │ │                                                                 │  │   │
│ │ └────────────────────────────────────────────────────────────────┘  │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 📋 右侧详情面板（选中版本时显示，可折叠）                                    │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ 📦 版本详情：产品A - ADAS ECU V1.0                                    │   │
│ │ ──────────────────────────────────────────────────────────────────── │   │
│ │                                                                       │   │
│ │ 基本信息：                                                            │   │
│ │ • 版本号：V1.0                                                        │   │
│ │ • 版本名称：工程样车版本                                              │   │
│ │ • 迭代区间：迭代1-6 (2025-02-01 ~ 2025-04-25, 12周)                  │   │
│ │ • 对齐里程碑：工程样车（EP）- 2025-06-30                              │   │
│ │ • 对齐状态：🟢 良好（预留66天buffer）                                 │   │
│ │                                                                       │   │
│ │ Epic范围：                                                            │   │
│ │ ┌─────────────────────────────────────────────────────────────┐     │   │
│ │ │ Epic ID      │ Epic名称       │ 完成度  │ SP   │ 操作   │     │   │
│ │ ├─────────────────────────────────────────────────────────────┤     │   │
│ │ │ ADAS-E001   │ L2+核心功能     │ 80%    │ 80   │ [详情] │     │   │
│ │ │ ADAS-E002   │ 传感器融合      │ 60%    │ 60   │ [详情] │     │   │
│ │ └─────────────────────────────────────────────────────────────┘     │   │
│ │                                                                       │   │
│ │ 统计信息：                                                            │   │
│ │ • 总SP：160 SP                                                        │   │
│ │ • Epic数：3个                                                         │   │
│ │ • Feature数：12个（预估）                                             │   │
│ │                                                                       │   │
│ │ 操作：                                                                │   │
│ │ [✏️ 编辑版本] [➕ 调整Epic] [👁️ 查看Feature] [🗑️ 删除版本]          │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔧 关键交互

### 交互1：创建新版本

**触发方式**：点击"+ 添加新产品版本"或产品下的"+ 新增版本"

**交互流程**：

```
1. 点击"+ 添加新产品版本"
   ↓
2. 弹出版本创建向导（Dialog/Drawer）
   ↓
3. 步骤1：选择产品和版本信息
   - 产品下拉选择
   - 版本号输入
   - 版本名称输入
   ↓
4. 步骤2：迭代区间映射
   - 在Timeline上拖拽选择迭代区间
   - 系统自动计算周期和日期
   - 自动建议对齐的里程碑
   ↓
5. 步骤3：Epic分配与完成度
   - 从项目Epic池选择Epic
   - 设置每个Epic的完成度（%）
   - 自动计算总SP
   ↓
6. 点击"创建版本"
   ↓
7. 版本条出现在Timeline上
   系统提示："版本创建成功！"
```

---

### 交互2：编辑版本迭代区间

**触发方式**：选中版本条，拖拽边界

**交互流程**：

```
1. 鼠标悬停在版本条上
   - 版本条高亮
   - 显示调整手柄（左右两端）
   ↓
2. 拖拽右边界调整结束迭代
   - 实时显示新的迭代区间
   - 实时计算新的周期
   ↓
3. 释放鼠标
   ↓
4. 系统检查对齐状态
   - 检查与里程碑的对齐关系
   - 显示对齐状态提示
   ↓
5. 系统提示："版本区间已调整，建议重新生成PI集合"
```

---

### 交互3：查看版本详情

**触发方式**：点击版本条

**交互流程**：

```
1. 点击版本条
   ↓
2. 右侧详情面板滑出（或底部展开）
   - 显示版本基本信息
   - 显示Epic列表
   - 显示统计信息
   ↓
3. 可进行以下操作：
   - 编辑版本
   - 查看Epic详情
   - 调整Epic分配
   - 删除版本
```

---

### 交互4：生成PI集合

**触发方式**：点击"生成PI集合"按钮

**交互流程**：

```
1. 点击"生成PI集合"
   ↓
2. 系统检查前置条件
   - 是否有版本数据
   - 版本是否都对齐了里程碑
   ↓
3. 显示确认对话框（如果已有PI）
   "PI集合将重新生成，现有PI Planning数据将保留，是否继续？"
   [取消] [确认]
   ↓
4. 执行PI生成算法
   - 按里程碑分组版本
   - 计算PI迭代区间
   - 汇总PI范围
   ↓
5. 生成成功
   显示成功消息："成功生成3个PI"
   提供跳转："查看PI集合"按钮
```

---

## 💾 数据模型

### 数据结构

```typescript
// 工作台数据
interface VersionPlanningWorkspace {
  projectId: string
  projectInfo: {
    name: string
    startDate: string
    endDate: string
    iterationWeeks: number  // 2周
    totalIterations: number // 26个
  }
  
  milestones: Milestone[]
  
  iterationAxis: {
    iterations: Iteration[]  // 26个迭代的详细信息
  }
  
  productVersions: ProductVersion[]  // 所有产品版本
  
  statistics: {
    totalVersions: number
    totalStoryPoints: number
    totalEpics: number
  }
}

// 产品版本
interface ProductVersion {
  versionId: string
  productId: string
  productName: string
  productCode: string
  productLine: string
  versionNumber: string
  versionName: string
  
  // 迭代映射
  startIterationNumber: number  // 1
  endIterationNumber: number    // 6
  iterationCount: number        // 6
  durationWeeks: number         // 12
  startDate: string             // 2025-02-01
  endDate: string               // 2025-04-25
  
  // 里程碑对齐
  alignedMilestoneId: string
  alignedMilestoneName: string
  milestoneDate: string
  milestoneGap: number  // 66天buffer
  alignmentStatus: 'good' | 'tight' | 'risk'
  
  // Epic范围
  epicAllocations: EpicAllocation[]
  totalStoryPoints: number
  
  // 状态
  status: 'draft' | 'confirmed' | 'in-progress' | 'completed'
  
  // 元数据
  createdBy: string
  createdAt: string
  updatedAt: string
}

// Epic分配
interface EpicAllocation {
  epicId: string
  epicName: string
  epicTotalSP: number
  completionPercentage: number  // 80%
  allocatedSP: number            // 80 SP
}

// 迭代
interface Iteration {
  iterationNumber: number
  startDate: string
  endDate: string
  durationWeeks: number
}

// 里程碑
interface Milestone {
  milestoneId: string
  milestoneName: string
  milestoneType: 'EP' | 'PP' | 'SOP'
  targetDate: string
  iterationNumber: number  // 对应的迭代号
}
```

---

## 🔌 API接口

### 接口列表

#### 1. 获取工作台数据

```typescript
GET /api/projects/{projectId}/version-planning-workspace

Response:
{
  projectInfo: { ... },
  milestones: [ ... ],
  iterationAxis: { ... },
  productVersions: [ ... ],
  statistics: { ... }
}
```

#### 2. 创建版本

```typescript
POST /api/projects/{projectId}/versions

Request Body:
{
  productId: string
  versionNumber: string
  versionName: string
  startIterationNumber: number
  endIterationNumber: number
  alignedMilestoneId: string
  epicAllocations: EpicAllocation[]
}

Response:
{
  versionId: string
  ...
}
```

#### 3. 更新版本

```typescript
PUT /api/projects/{projectId}/versions/{versionId}

Request Body:
{
  startIterationNumber?: number
  endIterationNumber?: number
  epicAllocations?: EpicAllocation[]
  ...
}
```

#### 4. 删除版本

```typescript
DELETE /api/projects/{projectId}/versions/{versionId}
```

#### 5. 生成PI集合

```typescript
POST /api/projects/{projectId}/pi-collection/generate

Response:
{
  pis: PI[]
  message: string
}
```

---

## 🎨 视觉设计

### 颜色方案

| 元素 | 颜色 | 说明 |
|------|------|------|
| **迭代轴背景** | `#f5f5f5` | 浅灰色背景 |
| **里程碑标注** | `#ff9800` | 橙色高亮 |
| **版本条-智能驾驶** | `#2196f3` | 蓝色 |
| **版本条-智能座舱** | `#9c27b0` | 紫色 |
| **版本条-EEA** | `#4caf50` | 绿色 |
| **对齐状态-良好** | `#4caf50` | 绿色 |
| **对齐状态-紧张** | `#ff9800` | 橙色 |
| **对齐状态-风险** | `#f44336` | 红色 |

### 版本条样式

```scss
.version-bar {
  height: 40px;
  border-radius: 4px;
  padding: 8px 12px;
  cursor: pointer;
  transition: all 0.3s;
  
  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  &.selected {
    border: 2px solid #1976d2;
    box-shadow: 0 0 0 3px rgba(25,118,210,0.1);
  }
  
  .version-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    
    .version-label {
      font-weight: 600;
      font-size: 14px;
    }
    
    .version-stats {
      font-size: 12px;
      opacity: 0.8;
    }
  }
}
```

---

## ✅ 验证规则

### 业务规则

1. **迭代区间验证**
   - 结束迭代必须 > 起始迭代
   - 迭代区间不能超出项目范围（1-26）

2. **Epic分配验证**
   - 至少选择1个Epic
   - Epic完成度总和不能超过100%
   - Epic不能重复分配到同一版本

3. **版本冲突检查**
   - 同一产品的不同版本可以有重叠的迭代区间（允许并行开发）
   - 但需要警告用户

4. **里程碑对齐验证**
   - 版本结束日期应早于或等于里程碑日期
   - 如果晚于里程碑，显示风险警告

---

## 🚀 实施要点

### 技术栈

- **框架**: Vue 3 + TypeScript
- **UI组件**: Element Plus
- **图表库**: ECharts (甘特图)
- **拖拽**: VueDraggable / @dnd-kit
- **状态管理**: Pinia

### 核心组件

```
VersionPlanningWorkspace.vue                 # 主页面
├── IterationAxisHeader.vue                  # 迭代轴头部
├── MilestoneMarker.vue                      # 里程碑标注
├── ProductVersionList.vue                   # 产品版本列表
│   ├── ProductGroupItem.vue                 # 产品分组
│   │   └── VersionBar.vue                   # 版本条
│   └── CreateVersionButton.vue              # 创建版本按钮
├── VersionDetailPanel.vue                   # 版本详情面板
└── PIGenerateButton.vue                     # PI生成按钮
```

### 关键算法

#### 1. 迭代区间转换

```typescript
function convertIterationToDate(
  iterationNumber: number,
  projectStartDate: string,
  iterationWeeks: number
): string {
  const startDate = new Date(projectStartDate)
  const daysOffset = (iterationNumber - 1) * iterationWeeks * 7
  const targetDate = new Date(startDate.getTime() + daysOffset * 24 * 60 * 60 * 1000)
  return targetDate.toISOString().split('T')[0]
}
```

#### 2. 里程碑对齐状态计算

```typescript
function calculateAlignmentStatus(
  versionEndDate: string,
  milestoneDate: string
): { status: string; gap: number } {
  const vEnd = new Date(versionEndDate)
  const mDate = new Date(milestoneDate)
  const gap = Math.floor((mDate.getTime() - vEnd.getTime()) / (24 * 60 * 60 * 1000))
  
  let status: 'good' | 'tight' | 'risk'
  if (gap >= 30) status = 'good'      // 预留30天以上
  else if (gap >= 0) status = 'tight' // 预留0-30天
  else status = 'risk'                // 晚于里程碑
  
  return { status, gap }
}
```

---

## 📊 与参考原型对比

### 与NIO NSDP TimePlan对比

| 维度 | NIO NSDP | 本系统 | 说明 |
|------|----------|--------|------|
| **迭代轴** | ✅ 有 | ✅ 统一全局迭代轴 | 概念一致 |
| **产品分组** | ✅ 有 | ✅ 按产品分组折叠 | 布局相似 |
| **甘特图** | ✅ 有 | ✅ 版本条甘特图 | 可视化对齐 |
| **里程碑** | ✅ 有 | ✅ Milestone标注 | 功能对齐 |
| **拖拽交互** | ✅ 有 | ✅ 版本条拖拽调整 | 交互增强 |
| **Epic管理** | ❓ 未知 | ✅ Epic分配和完成度 | 本系统增强 |

---

## 📝 测试用例

### 测试场景

| 场景 | 测试步骤 | 预期结果 |
|------|---------|---------|
| **TC-VP-01** | 进入工作台 | 显示迭代轴和已有版本 |
| **TC-VP-02** | 创建新版本 | 版本条出现在Timeline上 |
| **TC-VP-03** | 拖拽调整版本 | 版本区间实时更新 |
| **TC-VP-04** | 查看版本详情 | 详情面板显示Epic列表 |
| **TC-VP-05** | 生成PI集合 | 成功生成3个PI |
| **TC-VP-06** | 版本冲突检查 | 显示警告提示 |

---

## 🎯 成功指标

1. ✅ **功能完整性**：所有核心功能实现
2. ✅ **交互流畅性**：拖拽响应时间 < 100ms
3. ✅ **数据准确性**：迭代计算准确率100%
4. ✅ **用户满意度**：PO和架构师满意度 > 80%

---

**页面设计**: V3.0  
**状态**: ✅ **设计完成，待实施**  
**下一步**: 开始前端开发

---

**END OF DOCUMENT**
